{% extends "base.html" %}

{% block title %}Point of Sale - Hotel POS System{% endblock %}

{% block content %}

<!-- Modern POS Header -->
<div class="relative overflow-hidden bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900 rounded-2xl sm:rounded-3xl mb-4 sm:mb-8 shadow-2xl">
    <div class="absolute inset-0 bg-black/20"></div>
    <div class="relative px-4 py-6 sm:px-6 sm:py-8 lg:px-8 lg:py-12">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 sm:space-y-6 lg:space-y-0">
            <div class="text-white">
                <h1 class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-bold mb-2 sm:mb-3 bg-gradient-to-r from-white to-blue-200 bg-clip-text text-transparent">
                    Point of Sale
                </h1>
                <p class="text-blue-100 text-base sm:text-lg lg:text-xl font-medium">Process orders and manage transactions efficiently</p>
        </div>
            
            <!-- Modern Printer Controls -->
            <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-3 sm:space-y-0 sm:space-x-4">
                <!-- Printer Status Card -->
                <div id="printerStatusBadge" class="bg-white/10 backdrop-blur-sm border border-white/20 rounded-xl sm:rounded-2xl px-3 sm:px-4 py-2 sm:py-3 text-white w-full sm:w-auto">
        <div class="flex items-center space-x-3">
                        <div class="w-3 h-3 bg-red-400 rounded-full animate-pulse"></div>
        <div>
                            <p class="text-xs sm:text-sm font-medium">No Printers Connected</p>
                            <p class="text-xs text-blue-200 hidden sm:block">Click to connect</p>
        </div>
                    </div>
                </div>
                
                <!-- Printer Control Buttons -->
                <div class="flex items-center justify-center sm:justify-start space-x-1 sm:space-x-2 bg-white/10 backdrop-blur-sm border border-white/20 rounded-xl sm:rounded-2xl p-1.5 sm:p-2 w-full sm:w-auto">
                    <button id="connectPrinterBtn" class="group bg-blue-500/80 hover:bg-blue-500 text-white p-2 sm:p-3 rounded-lg sm:rounded-xl transition-all duration-300 hover:scale-105 hover:shadow-lg flex-1 sm:flex-none" title="Connect Bluetooth Printer">
                        <i class="fas fa-bluetooth text-xs sm:text-sm group-hover:animate-pulse"></i>
                    </button>
                    <button id="connectWifiPrinterBtn" class="group bg-purple-500/80 hover:bg-purple-500 text-white p-2 sm:p-3 rounded-lg sm:rounded-xl transition-all duration-300 hover:scale-105 hover:shadow-lg flex-1 sm:flex-none" title="Connect WiFi Printer">
                        <i class="fas fa-wifi text-xs sm:text-sm group-hover:animate-pulse"></i>
                    </button>
                    <div id="connected-printers-status" class="text-xs text-gray-600 hidden sm:block">
                        <!-- Connected printers status will be shown here -->
                    </div>
                    <button id="reprintBtn" class="group bg-purple-500/80 hover:bg-purple-500 text-white p-2 sm:p-3 rounded-lg sm:rounded-xl transition-all duration-300 hover:scale-105 hover:shadow-lg flex-1 sm:flex-none" title="Reprint Receipt">
                        <i class="fas fa-redo-alt text-xs sm:text-sm"></i>
                    </button>
                    <button id="testPrintBtn" class="group bg-green-500/80 hover:bg-green-500 text-white p-2 sm:p-3 rounded-lg sm:rounded-xl transition-all duration-300 hover:scale-105 hover:shadow-lg flex-1 sm:flex-none" title="Test Print">
                        <i class="fas fa-print text-xs sm:text-sm"></i>
                    </button>
                    <button id="printerInfoBtn" class="group bg-gray-500/80 hover:bg-gray-500 text-white p-2 sm:p-3 rounded-lg sm:rounded-xl transition-all duration-300 hover:scale-105 hover:shadow-lg flex-1 sm:flex-none" title="Printer Info">
                        <i class="fas fa-info text-xs sm:text-sm"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Printer Setup Modal -->
<div id="printerSetupModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 rounded-t-2xl">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold">Printer Setup</h2>
                    <button id="closePrinterSetup" class="text-white/80 hover:text-white text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Modal Content -->
            <div class="p-6">
                <!-- Printer Type Selection -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-4">Select Printer Type</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-blue-500 transition-colors">
                            <input type="radio" name="printer-type" value="bluetooth" class="mr-3">
                            <div>
                                <div class="font-medium">Bluetooth Printer</div>
                                <div class="text-sm text-gray-600">Connect via Bluetooth</div>
                            </div>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-blue-500 transition-colors">
                            <input type="radio" name="printer-type" value="wifi" class="mr-3">
                            <div>
                                <div class="font-medium">WiFi Printer</div>
                                <div class="text-sm text-gray-600">Connect via Network</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Scan Section -->
                <div id="scanSection" class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">Scan for Printers</h3>
                        <button id="scan-printers" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-search mr-2"></i>Scan for Printers
                        </button>
                    </div>
                    <div id="printers-list" class="space-y-2 max-h-40 overflow-y-auto">
                        <!-- Scanned printers will appear here -->
                    </div>
                </div>

                <!-- Manual Connection Section -->
                <div id="manualSection" class="mb-6">
                    <h3 class="text-lg font-semibold mb-4">Manual Connection</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Printer Name</label>
                            <input type="text" id="printer-name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter printer name">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Printer Address</label>
                            <input type="text" id="printer-address" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter IP address or Bluetooth ID">
                        </div>
                        <button id="connect-manual-printer" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg transition-colors">
                            <i class="fas fa-link mr-2"></i>Connect
                        </button>
                    </div>
                </div>

                <!-- Bluetooth Scanning Interface -->
                <div id="bluetoothScanInterface" class="hidden">
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-blue-800">Bluetooth Scanning</h3>
                            <button id="cancel-bluetooth-scan" class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="bluetooth-devices-list" class="space-y-2">
                            <!-- Bluetooth devices will appear here -->
                        </div>
                        <button id="pair-bluetooth-device" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg mt-4 transition-colors">
                            <i class="fas fa-link mr-2"></i>Pair Device
                        </button>
                    </div>
                </div>

                <!-- Disconnect Section -->
                <div class="border-t pt-4">
                    <button id="disconnect-printer" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg transition-colors">
                        <i class="fas fa-unlink mr-2"></i>Disconnect Printer
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mobile Floating Cart Button -->
<div id="mobileCartBtn" class="md:hidden">
    <button id="mobileCartButton" class="mobile-cart-button">
        <i class="fas fa-shopping-cart text-xl text-white"></i>
        <div id="cartCountBadge" class="cart-count-badge hidden">
            <span id="cartCount">0</span>
        </div>
        <div id="cartPulse" class="cart-pulse hidden"></div>
    </button>
</div>

<!-- Mobile Cart Popup -->
<div id="mobileCartPopup" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden md:hidden">
    <div class="flex items-end justify-center min-h-screen p-2 sm:p-4">
        <div id="mobileCartContent" class="bg-white rounded-t-2xl sm:rounded-t-3xl w-full max-w-sm sm:max-w-md lg:max-w-lg xl:max-w-xl max-h-[85vh] sm:max-h-[80vh] overflow-hidden transform transition-transform duration-300 translate-y-full shadow-2xl">
            <!-- Mobile Cart Header -->
            <div class="flex items-center justify-between p-3 sm:p-4 border-b border-gray-200 bg-gradient-to-r from-primary-orange to-secondary-orange text-white">
                <div class="flex items-center space-x-2 sm:space-x-3">
                    <div class="w-6 h-6 sm:w-8 sm:h-8 bg-white bg-opacity-20 rounded-lg sm:rounded-xl flex items-center justify-center">
                        <i class="fas fa-shopping-cart text-white text-xs sm:text-sm"></i>
                    </div>
                    <h2 class="text-base sm:text-lg lg:text-xl font-bold text-white">Your Order</h2>
                </div>
                <button id="closeMobileCartBtn" class="text-white hover:text-gray-200 transition-colors p-1 sm:p-2 touch-target">
                    <i class="fas fa-times text-lg sm:text-xl"></i>
                </button>
            </div>
        
            <!-- Mobile Cart Content -->
            <div class="flex-1 overflow-y-auto p-3 sm:p-4">
                <!-- Mobile Order Items -->
                <div id="mobileOrderItems" class="space-y-2 sm:space-y-3 mb-3 sm:mb-4">
                    <!-- Empty cart state -->
                    <div id="mobileEmptyCart" class="text-center py-8 sm:py-12">
                        <div class="w-16 h-16 sm:w-20 sm:h-20 bg-gradient-to-br from-gray-100 to-gray-200 rounded-2xl sm:rounded-3xl flex items-center justify-center mx-auto mb-4 sm:mb-6 shadow-lg">
                            <i class="fas fa-shopping-cart text-gray-400 text-2xl sm:text-3xl"></i>
                        </div>
                        <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-2 sm:mb-3">Your cart is empty</h3>
                        <p class="text-sm sm:text-base text-gray-600">Add items from the menu to get started</p>
                    </div>
                </div>

                <!-- Mobile Order Summary -->
                <div id="mobileOrderSummary" class="border-t border-gray-200 pt-3 sm:pt-4 space-y-2 hidden">
                    <div class="flex justify-between text-gray-600 text-sm sm:text-base">
                        <span>Subtotal:</span>
                        <span id="mobileSubtotal">KSh 0.00</span>
                    </div>
                    <div id="mobileTaxLine" class="flex justify-between text-gray-600 text-sm sm:text-base">
                        <span>Tax (8%):</span>
                        <span id="mobileTax">KSh 0.00</span>
                    </div>
                    <div class="flex justify-between text-base sm:text-lg font-bold text-gray-800 border-t border-gray-200 pt-2">
                        <span>Total:</span>
                        <span id="mobileTotal">KSh 0.00</span>
                    </div>
                </div>

                <!-- Mobile Employee Validation -->
                <div id="mobileEmployeeValidation" class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg sm:rounded-xl p-3 sm:p-4 mt-3 sm:mt-4 hidden">
                    <div class="flex items-center justify-between mb-2 sm:mb-3">
                        <h3 class="text-base sm:text-lg font-semibold text-blue-800 flex items-center">
                            <i class="fas fa-user-check mr-1 sm:mr-2 text-sm sm:text-base"></i>
                            <span class="text-sm sm:text-base">Employee Validation</span>
                        </h3>
                        <div id="mobileEmployeeValidationStatus" class="w-3 h-3 bg-gray-400 rounded-full"></div>
                    </div>
                    <div class="space-y-2 sm:space-y-3">
                        <div id="mobileEmployeeValidationWarning" class="bg-yellow-50 border border-yellow-200 rounded-lg p-2 sm:p-3 text-yellow-700 text-xs sm:text-sm hidden">
                            <i class="fas fa-exclamation-triangle mr-1 sm:mr-2"></i>
                            Please connect a printer first (Bluetooth or WiFi)
                        </div>
                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">Employee Code (4 digits)</label>
                            <input type="text" id="mobileReceiptEmployeeCode" maxlength="4" 
                                   class="w-full px-3 sm:px-4 py-2 sm:py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center text-base sm:text-lg font-mono tracking-widest touch-target"
                                   placeholder="0000" required>
                            <div id="mobileEmployeeValidationMessage" class="mt-1 sm:mt-2 text-xs sm:text-sm"></div>
                        </div>
                        <div id="mobileEmployeeInfo" class="hidden bg-white rounded-lg p-2 sm:p-3 border border-blue-200">
                            <div class="flex items-center space-x-2 sm:space-x-3">
                                <div class="w-8 h-8 sm:w-10 sm:h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-blue-600 text-sm sm:text-base"></i>
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-800 text-sm sm:text-base" id="mobileEmployeeName">Employee Name</div>
                                    <div class="text-xs sm:text-sm text-gray-600" id="mobileEmployeeCode">Code: 0000</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reprint Receipt Modal -->
<div id="reprintModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-4 sm:p-6 border-b border-gray-200 bg-gradient-to-r from-purple-50 to-indigo-50">
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-redo-alt text-white text-sm"></i>
                </div>
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Reprint Receipt</h2>
            </div>
            <button id="closeReprintModal" class="text-gray-500 hover:text-gray-700 p-2">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- Modal Content -->
        <div class="p-4 sm:p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
            <!-- Step 1: Receipt Selection -->
            <div id="receiptSelectionStep" class="space-y-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-800">Step 1: Select Receipt to Reprint</h3>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="receiptSearch" placeholder="Search receipts..." 
                               class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm">
                        <button id="refreshReceipts" class="bg-purple-500 text-white px-3 py-2 rounded-lg hover:bg-purple-600 transition-colors duration-200">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="receiptsLoading" class="text-center py-8">
                    <div class="inline-flex items-center space-x-2 text-gray-500">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-500"></div>
                        <span>Loading receipts...</span>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="receiptsEmpty" class="text-center py-12 hidden">
                    <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-receipt text-gray-400 text-3xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">No Receipts Found</h3>
                    <p class="text-gray-600">No printed receipts available for reprinting.</p>
                </div>

                <!-- Receipts List -->
                <div id="receiptsList" class="space-y-3 hidden">
                    <!-- Dynamic receipt items will be loaded here -->
                </div>
            </div>

            <!-- Step 2: Employee Validation (Hidden initially) -->
            <div id="employeeValidationStep" class="hidden">
                <!-- Selected Receipt Info -->
                <div id="selectedReceiptInfo" class="bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-xl p-4 mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold text-purple-800 flex items-center">
                            <i class="fas fa-receipt mr-2"></i>
                            Selected Receipt
                        </h3>
                        <button id="changeReceiptBtn" class="text-purple-600 hover:text-purple-800 text-sm font-medium">
                            <i class="fas fa-edit mr-1"></i>
                            Change
                        </button>
                    </div>
                    <div id="selectedReceiptDetails" class="text-sm text-gray-700">
                        <!-- Selected receipt details will be populated here -->
                    </div>
                </div>

                <!-- Employee Validation Section -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-4 mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold text-blue-800 flex items-center">
                            <i class="fas fa-user-check mr-2"></i>
                            Step 2: Employee Validation
                        </h3>
                        <div id="reprintEmployeeValidationStatus" class="w-3 h-3 bg-gray-400 rounded-full"></div>
                    </div>
                    <div class="space-y-3">
                        <div id="reprintEmployeeValidationWarning" class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-yellow-700 text-sm hidden">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            Please connect a printer first (Bluetooth or WiFi)
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Employee Code (4 digits)</label>
                            <input type="text" id="reprintEmployeeCode" maxlength="4" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center text-lg font-mono tracking-widest"
                                   placeholder="0000" required>
                            <div id="reprintEmployeeValidationMessage" class="mt-2 text-sm"></div>
                        </div>
                        <div id="reprintEmployeeInfo" class="hidden bg-white rounded-lg p-3 border border-blue-200">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-blue-600"></i>
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-800" id="reprintEmployeeName">Employee Name</div>
                                    <div class="text-sm text-gray-600" id="reprintEmployeeCodeDisplay">Code: 0000</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="flex items-center justify-end space-x-3 p-4 sm:p-6 border-t border-gray-200 bg-gray-50">
            <button id="cancelReprint" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors duration-200">
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- POS Main Content -->
<div class="grid grid-cols-1 lg:grid-cols-12 gap-4 sm:gap-6 lg:gap-8">
    <!-- Modern Menu Items Section -->
    <div class="lg:col-span-8 xl:col-span-8">
        <div class="bg-white rounded-2xl sm:rounded-3xl shadow-xl border border-gray-100/50 overflow-hidden">
            <div class="bg-gradient-to-r from-gray-50 to-gray-100/50 px-4 py-3 sm:px-6 sm:py-4 border-b border-gray-200/50">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-3 sm:space-y-4 lg:space-y-0">
                    <div class="flex items-center space-x-3">
                        <div class="w-6 h-6 sm:w-8 sm:h-8 bg-gradient-to-br from-primary-orange to-secondary-orange rounded-lg sm:rounded-xl flex items-center justify-center">
                            <i class="fas fa-utensils text-white text-xs sm:text-sm"></i>
                        </div>
                        <h2 class="text-lg sm:text-xl font-bold text-gray-800">Menu Items</h2>
                    </div>
                    <div class="flex flex-col sm:flex-row items-stretch sm:items-center space-y-2 sm:space-y-0 sm:space-x-3">
                        <div class="relative">
                            <input type="text" placeholder="Search items..." class="w-full sm:w-48 md:w-64 px-3 py-2 sm:px-4 sm:py-3 pl-9 sm:pl-10 border border-gray-200 rounded-lg sm:rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-orange focus:border-primary-orange text-sm bg-white shadow-sm transition-all duration-200">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs sm:text-sm"></i>
                        </div>
                        <button class="bg-gradient-to-r from-primary-orange to-secondary-orange text-white px-4 py-2 sm:px-6 sm:py-3 rounded-lg sm:rounded-xl hover:from-secondary-orange hover:to-primary-orange transition-all duration-300 hover:scale-105 hover:shadow-lg font-medium flex items-center justify-center space-x-2 text-sm sm:text-base">
                            <i class="fas fa-search text-xs sm:text-sm"></i>
                            <span class="hidden sm:inline">Search</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="p-3 sm:p-4 md:p-6">
                <!-- Menu Categories -->
                <div class="flex flex-wrap gap-1.5 sm:gap-2 mb-3 sm:mb-4 md:mb-6" id="categoryFilters">
                    <button class="category-filter bg-primary-orange text-white px-3 py-2 sm:px-4 sm:py-2.5 md:px-6 md:py-3 rounded-lg sm:rounded-xl hover:bg-secondary-orange transition-all duration-200 text-xs sm:text-sm md:text-base font-medium shadow-md hover:shadow-lg" data-category="all">
                        All Items
                    </button>
                    <!-- Dynamic categories will be loaded here -->
                </div>

                <!-- Menu Items by Category -->
                <div id="menuItemsContainer">
                    <!-- Loading State -->
                    <div id="loadingState" class="text-center py-12">
                        <div class="inline-flex items-center space-x-2 text-gray-500">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary-orange"></div>
                            <span>Loading menu items...</span>
                        </div>
                    </div>
                    
                    <!-- Empty State -->
                    <div id="emptyState" class="text-center py-12 hidden">
                        <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-utensils text-gray-400 text-3xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">No Items Available</h3>
                        <p class="text-gray-600">No active menu items found. Please check back later.</p>
                    </div>
                    
                    <!-- Dynamic menu items by category will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modern Order Summary -->
    <div class="lg:col-span-4 xl:col-span-4 space-y-6">
        <!-- Current Order Card -->
        <div id="desktopCart" class="bg-white rounded-2xl sm:rounded-3xl shadow-xl border border-gray-100/50 overflow-hidden hidden md:block">
            <div class="bg-gradient-to-r from-gray-50 to-gray-100/50 px-4 py-3 sm:px-6 sm:py-4 border-b border-gray-200/50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2 sm:space-x-3">
                        <div class="w-6 h-6 sm:w-8 sm:h-8 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg sm:rounded-xl flex items-center justify-center">
                            <i class="fas fa-shopping-cart text-white text-xs sm:text-sm"></i>
                        </div>
                        <h2 class="text-lg sm:text-xl font-bold text-gray-800">Current Order</h2>
                    </div>
                    <button id="clearCartBtn" class="group bg-red-50 hover:bg-red-100 text-red-600 hover:text-red-700 px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg sm:rounded-xl font-medium text-xs sm:text-sm transition-all duration-200 hover:scale-105">
                        <i class="fas fa-trash mr-1 sm:mr-2 group-hover:animate-pulse text-xs sm:text-sm"></i>
                        <span class="hidden sm:inline">Clear</span>
                    </button>
                </div>
            </div>
            <div class="p-3 sm:p-4 md:p-6">
                <!-- Order Items -->
                <div id="orderItems" class="space-y-3 mb-4">
                    <!-- Modern Empty cart state -->
                    <div id="emptyCart" class="text-center py-12">
                        <div class="w-20 h-20 bg-gradient-to-br from-gray-100 to-gray-200 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-lg">
                            <i class="fas fa-shopping-cart text-gray-400 text-3xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-3">Your cart is empty</h3>
                        <p class="text-gray-600">Add items from the menu to get started</p>
                    </div>
                    
                    <!-- Dynamic order items will be loaded here -->
                </div>

                <!-- Order Summary -->
                <div id="orderSummary" class="border-t border-gray-200 pt-4 space-y-2 hidden">
                    <div class="flex justify-between text-gray-600 text-sm sm:text-base">
                        <span>Subtotal:</span>
                        <span id="subtotal">KSh 0.00</span>
                    </div>
                    <div id="taxLine" class="flex justify-between text-gray-600 text-sm sm:text-base">
                        <span>Tax (8%):</span>
                        <span id="tax">KSh 0.00</span>
                    </div>
                    <div class="flex justify-between text-base sm:text-lg font-bold text-gray-800 border-t border-gray-200 pt-2">
                        <span>Total:</span>
                        <span id="total">KSh 0.00</span>
                    </div>
                </div>

                <!-- Till/Cash Drawer Section -->
                <div id="tillSection" class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl p-4 mt-4 hidden">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold text-green-800 flex items-center">
                            <i class="fas fa-cash-register mr-2"></i>
                            Cash Drawer
                        </h3>
                        <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="bg-white rounded-lg p-3 border border-green-200">
                            <div class="text-green-600 font-medium">Opening Balance</div>
                            <div class="text-lg font-bold text-green-800">KSh 5,000.00</div>
                        </div>
                        <div class="bg-white rounded-lg p-3 border border-green-200">
                            <div class="text-green-600 font-medium">Current Total</div>
                            <div class="text-lg font-bold text-green-800" id="tillTotal">KSh 0.00</div>
                        </div>
                    </div>
                    <div class="mt-3 text-xs text-green-600">
                        <i class="fas fa-info-circle mr-1"></i>
                        Cash drawer automatically opens on payment processing
                    </div>
                </div>

                <!-- Action Buttons -->
                <!-- Modern Action Buttons -->
                <div id="actionButtons" class="mt-6 space-y-4 hidden">
                    <!-- Employee Code Input Section -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg sm:rounded-xl p-3 sm:p-4">
                        <div class="flex items-center justify-between mb-2 sm:mb-3">
                            <h3 class="text-base sm:text-lg font-semibold text-blue-800 flex items-center">
                                <i class="fas fa-user-check mr-1 sm:mr-2 text-sm sm:text-base"></i>
                                <span class="hidden sm:inline">Employee Validation</span>
                                <span class="sm:hidden">Validation</span>
                            </h3>
                            <div id="employeeValidationStatus" class="w-2.5 h-2.5 sm:w-3 sm:h-3 bg-gray-400 rounded-full"></div>
                </div>
                        <div class="space-y-2 sm:space-y-3">
                            <div>
                                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">Employee Code (4 digits)</label>
                                <input type="text" id="receiptEmployeeCode" maxlength="4" 
                                       class="w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center text-base sm:text-lg font-mono tracking-widest"
                                       placeholder="0000" required>
                                <div id="employeeValidationMessage" class="mt-1 sm:mt-2 text-xs sm:text-sm"></div>
                            </div>
                            <div id="employeeInfo" class="hidden bg-white rounded-lg p-2 sm:p-3 border border-blue-200">
                                <div class="flex items-center space-x-2 sm:space-x-3">
                                    <div class="w-8 h-8 sm:w-10 sm:h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-user text-blue-600 text-xs sm:text-sm"></i>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-gray-800 text-sm sm:text-base" id="employeeName">Employee Name</div>
                                        <div class="text-xs sm:text-sm text-gray-600" id="employeeCode">Code: 0000</div>
                                    </div>
                                </div>
                            </div>
            </div>
        </div>

                    <!-- Action Buttons Removed - Auto-validation handles printing -->
                </div>
    </div>
</div>

    </div>
</div>


{% endblock %}

{% block extra_scripts %}
<!-- Bootstrap JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<style>
    .hover\:scale-102:hover {
        transform: scale(1.02);
    }
    
    
    .line-clamp-1 {
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    /* Custom scrollbar for horizontal scrolling */
    .scrollbar-thin {
        scrollbar-width: thin;
    }
    
    .scrollbar-thin::-webkit-scrollbar {
        height: 6px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
    
    /* Smooth scrolling */
    .overflow-x-auto {
        scroll-behavior: smooth;
    }
    
    /* Mobile optimizations */
    @media (max-width: 640px) {
        /* Reduce padding on mobile */
        .mobile-padding {
            padding: 0.75rem !important;
        }
        
        /* Smaller text on mobile */
        .mobile-text-sm {
            font-size: 0.875rem !important;
        }
        
        /* Full width buttons on mobile */
        .mobile-full-width {
            width: 100% !important;
        }
        
        /* Compact spacing on mobile */
        .mobile-compact {
            gap: 0.5rem !important;
        }
    }
    
    /* Tablet optimizations */
    @media (min-width: 641px) and (max-width: 1024px) {
        /* Adjust grid for tablet */
        .tablet-grid {
            grid-template-columns: 1fr !important;
        }
        
        /* Tablet spacing */
        .tablet-spacing {
            gap: 1rem !important;
        }
    }
    
    /* Desktop optimizations */
    @media (min-width: 1025px) {
        /* Enhanced shadows on desktop */
        .desktop-shadow {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25) !important;
        }
    }
    
    /* Touch-friendly sizing */
    .touch-target {
        min-height: 44px;
        min-width: 44px;
    }
    
    /* Enhanced mobile cart button */
    .mobile-cart-button {
        position: fixed;
        bottom: 1.5rem;
        right: 1.5rem;
        z-index: 50;
        width: 3.5rem;
        height: 3.5rem;
        border-radius: 50%;
        background: linear-gradient(135deg, #FF6B35 0%, #FF8C42 100%);
        box-shadow: 0 8px 32px rgba(255, 107, 53, 0.4);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        outline: none;
    }
    
    @media (min-width: 480px) {
        .mobile-cart-button {
            width: 4rem;
            height: 4rem;
        }
    }
    
    @media (min-width: 768px) {
        .mobile-cart-button {
            width: 4.5rem;
            height: 4.5rem;
        }
    }
    
    .mobile-cart-button:hover {
        transform: scale(1.1);
        box-shadow: 0 12px 40px rgba(255, 107, 53, 0.6);
    }
    
    .mobile-cart-button:active {
        transform: scale(0.95);
    }
    
    /* Cart count badge */
    .cart-count-badge {
        position: absolute;
        top: -0.5rem;
        right: -0.5rem;
        background: #ef4444;
        color: white;
        font-size: 0.75rem;
        font-weight: bold;
        border-radius: 50%;
        width: 1.5rem;
        height: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 0;
        border: 2px solid white;
        animation: cartBadgePulse 0.6s ease-out;
    }
    
    @keyframes cartBadgePulse {
        0% { transform: scale(0.8); opacity: 0.8; }
        50% { transform: scale(1.2); opacity: 1; }
        100% { transform: scale(1); opacity: 1; }
    }
    
    /* Cart pulse animation */
    .cart-pulse {
        position: absolute;
        inset: 0;
        background: #FF6B35;
        border-radius: 50%;
        animation: cartPulse 1s ease-out;
    }
    
    @keyframes cartPulse {
        0% { transform: scale(1); opacity: 0.75; }
        100% { transform: scale(1.4); opacity: 0; }
    }
    
    /* Cart active state */
    .mobile-cart-button.cart-has-items {
        animation: cartButtonGlow 2s ease-in-out infinite;
    }
    
    @keyframes cartButtonGlow {
        0%, 100% { box-shadow: 0 8px 32px rgba(255, 107, 53, 0.4); }
        50% { box-shadow: 0 8px 32px rgba(255, 107, 53, 0.8); }
    }
    
    /* Responsive typography */
    .responsive-text {
        font-size: clamp(0.875rem, 2.5vw, 1.125rem);
    }
    
    /* Responsive spacing */
    .responsive-padding {
        padding: clamp(0.75rem, 3vw, 1.5rem);
    }
    
    /* Mobile cart animations */
    .mobile-cart-enter {
        transform: translateY(100%);
        opacity: 0;
    }
    
    .mobile-cart-enter-active {
        transform: translateY(0);
        opacity: 1;
        transition: all 0.3s ease-out;
    }
    
    .mobile-cart-exit {
        transform: translateY(0);
        opacity: 1;
    }
    
    .mobile-cart-exit-active {
        transform: translateY(100%);
        opacity: 0;
        transition: all 0.3s ease-in;
    }
    
    /* Enhanced responsive mobile cart */
    @media (max-width: 320px) {
        #mobileCartContent {
            max-height: 90vh !important;
            border-radius: 1rem !important;
        }
        
        .mobile-cart-button {
            width: 3.5rem !important;
            height: 3.5rem !important;
            bottom: 1rem !important;
            right: 1rem !important;
        }
    }
    
    @media (min-width: 321px) and (max-width: 480px) {
        #mobileCartContent {
            max-height: 85vh !important;
        }
    }
    
    @media (min-width: 481px) and (max-width: 768px) {
        #mobileCartContent {
            max-height: 80vh !important;
            max-width: 28rem !important;
        }
    }
    
    @media (min-width: 769px) and (max-width: 1024px) {
        #mobileCartContent {
            max-height: 75vh !important;
            max-width: 32rem !important;
        }
    }
    
    /* Landscape orientation adjustments */
    @media (max-height: 500px) and (orientation: landscape) {
        #mobileCartContent {
            max-height: 95vh !important;
        }
        
        .mobile-cart-button {
            bottom: 0.5rem !important;
            right: 0.5rem !important;
        }
    }
    
    /* Very small screens */
    @media (max-width: 280px) {
        #mobileCartContent {
            max-height: 95vh !important;
            border-radius: 0.75rem !important;
        }
        
        .mobile-cart-button {
            width: 3rem !important;
            height: 3rem !important;
            bottom: 0.75rem !important;
            right: 0.75rem !important;
        }
    }
    
    /* Stock Display Styling */
    .stock-low {
        background-color: #fef2f2 !important;
        border: 2px solid #fca5a5 !important;
        animation: pulse-red 2s infinite;
    }
    
    .stock-out {
        background-color: #fef2f2 !important;
        border: 2px solid #ef4444 !important;
        opacity: 0.7;
    }
    
    .stock-good {
        background-color: #f0fdf4 !important;
        border: 1px solid #bbf7d0 !important;
    }
    
    .stock-no-tracking {
        background-color: #eff6ff !important;
        border: 1px solid #93c5fd !important;
    }
    
    @keyframes pulse-red {
        0%, 100% {
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
        }
        50% {
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1);
        }
    }
    
    /* Stock quantity badges */
    .stock-badge {
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
    
    .stock-badge.low-stock {
        background: linear-gradient(135deg, #fef2f2, #fee2e2);
        color: #dc2626;
        border: 1px solid #fca5a5;
        box-shadow: 0 1px 3px rgba(239, 68, 68, 0.1);
    }
    
    .stock-badge.out-of-stock {
        background: linear-gradient(135deg, #fef2f2, #fecaca);
        color: #dc2626;
        border: 1px solid #ef4444;
        box-shadow: 0 1px 3px rgba(239, 68, 68, 0.2);
    }
    
    .stock-badge.in-stock {
        background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        color: #16a34a;
        border: 1px solid #86efac;
        box-shadow: 0 1px 3px rgba(34, 197, 94, 0.1);
    }
    
    .stock-badge.no-tracking {
        background: linear-gradient(135deg, #eff6ff, #dbeafe);
        color: #2563eb;
        border: 1px solid #93c5fd;
        box-shadow: 0 1px 3px rgba(59, 130, 246, 0.1);
    }
</style>
<script>
    // Global variables
    let allItems = [];
    let filteredItems = [];
    let currentOrder = [];
    let selectedCategory = 'all';
    let posInitialized = false;
    let printers = [];
    
    // Hotel settings
    const hotelName = '{{ hotel_settings.hotel_name if hotel_settings else "KWETU DELIVERIES" }}';
    let foundPrinters = [];
    
    // Reprint functionality variables
    let reprintReceipts = [];
    let selectedReceipt = null;
    let reprintEmployee = null;
    
    // Cache DOM elements to avoid repeated queries
    let cachedDOMElements = {};
    
    // Debug function - can be called from console
    window.debugCart = function() {
        console.log('=== CART DEBUG ===');
        console.log('posInitialized:', posInitialized);
        console.log('currentOrder:', currentOrder);
        console.log('currentOrder.length:', currentOrder.length);
        console.log('Cached DOM elements:');
        console.log('  orderItems:', !!cachedDOMElements.orderItems);
        console.log('  emptyCart:', !!cachedDOMElements.emptyCart);
        console.log('  orderSummary:', !!cachedDOMElements.orderSummary);
        console.log('  actionButtons:', !!cachedDOMElements.actionButtons);
        console.log('  subtotal:', !!cachedDOMElements.subtotal);
        console.log('  tax:', !!cachedDOMElements.tax);
        console.log('  total:', !!cachedDOMElements.total);
        console.log('Fresh DOM elements:');
        console.log('  orderItems:', !!document.getElementById('orderItems'));
        console.log('  emptyCart:', !!document.getElementById('emptyCart'));
        console.log('  orderSummary:', !!document.getElementById('orderSummary'));
        console.log('  actionButtons:', !!document.getElementById('actionButtons'));
        console.log('==================');
    };
    
    // Force refresh cart display - can be called from console
    window.refreshCart = function() {
        console.log('Force refreshing cart display...');
        updateOrderDisplay();
    };
    
    // Refresh cached DOM elements - can be called from console
    window.refreshDOMElements = function() {
        console.log('Refreshing cached DOM elements...');
        cachedDOMElements = {
            orderItems: document.getElementById('orderItems'),
            emptyCart: document.getElementById('emptyCart'),
            orderSummary: document.getElementById('orderSummary'),
            actionButtons: document.getElementById('actionButtons'),
            subtotal: document.getElementById('subtotal'),
            tax: document.getElementById('tax'),
            total: document.getElementById('total')
        };
        console.log('DOM elements refreshed:', Object.keys(cachedDOMElements));
    };
    
    // Get image display setting from localStorage
    function getImageDisplaySetting() {
        const savedSettings = localStorage.getItem('pos-settings');
        if (savedSettings) {
            const settings = JSON.parse(savedSettings);
            return settings.images?.show !== false; // Default to true
        }
        return true; // Default to showing images
    }
    
    // Get tax setting from localStorage
    function getTaxSetting() {
        const savedSettings = localStorage.getItem('pos-settings');
        if (savedSettings) {
            const settings = JSON.parse(savedSettings);
            return settings.tax?.include !== false; // Default to true
        }
        return true; // Default to including tax
    }
    
    // Get till display setting from localStorage
    function getTillDisplaySetting() {
        const savedSettings = localStorage.getItem('pos-settings');
        if (savedSettings) {
            const settings = JSON.parse(savedSettings);
            return settings.till?.show || false; // Default to false
        }
        return false; // Default to not showing till
    }
    
    // Update image display setting (called from settings modal)
    window.updateImageDisplay = function(showImages) {
        console.log('Updating image display setting:', showImages);
        // Re-render menu items with new setting
        renderMenuItems();
    };
    
    // Update tax setting (called from settings modal)
    window.updateTaxSetting = function(includeTax) {
        console.log('Updating tax setting:', includeTax);
        // Re-calculate order summary with new tax setting
        updateOrderSummary();
    };
    
    // Global variable to store till display setting
    let showTillOnReceipt = false;

    // Update till/cash drawer display setting (called from settings modal)
    window.updateTillDisplay = function(showTill) {
        console.log('Updating till display setting:', showTill);
        showTillOnReceipt = showTill;
        
        // Note: This setting only controls M-Pesa payment info on receipts
        // No UI changes needed in the cart interface
    };

    // Get current till display setting
    function getTillSetting() {
        // First check if we have a cached value
        if (showTillOnReceipt !== undefined) {
            return showTillOnReceipt;
        }
        // Otherwise get from localStorage
        return getTillDisplaySetting();
    }
    
    
    // Get appropriate icon for item category
    function getItemIcon(category) {
        const categoryLower = category.toLowerCase();
        if (categoryLower.includes('meat') || categoryLower.includes('beef') || categoryLower.includes('chicken')) {
            return 'fa-drumstick-bite';
        } else if (categoryLower.includes('accompaniment') || categoryLower.includes('ugali') || categoryLower.includes('rice')) {
            return 'fa-bread-slice';
        } else if (categoryLower.includes('drink') || categoryLower.includes('beverage')) {
            return 'fa-coffee';
        } else if (categoryLower.includes('snack') || categoryLower.includes('chips')) {
            return 'fa-cookie-bite';
        } else if (categoryLower.includes('vegetable') || categoryLower.includes('salad')) {
            return 'fa-leaf';
        } else if (categoryLower.includes('soup') || categoryLower.includes('stew')) {
            return 'fa-bowl-food';
        } else {
            return 'fa-utensils';
        }
    }
    
    // Get stock badge class for styling
    function getStockBadgeClass(item) {
        if (!item.stock_update_enabled) {
            return ''; // No badge for items without stock tracking
        } else if (item.stock === 0) {
            return 'text-xs font-medium text-red-600'; // Red for out of stock
        } else if (item.stock < 10) {
            return 'text-xs font-medium text-red-500'; // Red for low stock
        } else {
            return 'text-xs font-medium text-gray-600'; // Gray for good stock
        }
    }
    
    // Get stock text with quantities
    function getStockText(item) {
        if (!item.stock_update_enabled) {
            return ''; // Don't show anything for items without stock tracking
        } else {
            return `${item.stock}`; // Just show the quantity number
        }
    }
    
    // Get card class based on stock status
    function getStockCardClass(item) {
        return ''; // No special card styling
    }

    // Initialize POS system
    document.addEventListener('DOMContentLoaded', function() {
        // Wait a bit to ensure all elements are rendered
        setTimeout(() => {
            initializePOS();
            updatePrinterSetupNotice();
            initializeNavigationConfirmation();
        }, 100);
    });

    // Initialize navigation confirmation to prevent accidental printer disconnection
    function initializeNavigationConfirmation() {
        let hasUnsavedChanges = false;
        let isProcessing = false;
        
        // Track when there are items in cart or processing is happening
        function updateUnsavedChanges() {
            hasUnsavedChanges = currentOrder.length > 0 || isProcessing;
        }
        
        // Override the original updateOrderDisplay to track changes
        const originalUpdateOrderDisplay = updateOrderDisplay;
        updateOrderDisplay = function() {
            originalUpdateOrderDisplay.call(this);
            updateUnsavedChanges();
        };
        
        // Track processing state
        const originalProcessPayment = processPayment;
        processPayment = function() {
            isProcessing = true;
            updateUnsavedChanges();
            return originalProcessPayment.call(this).finally(() => {
                isProcessing = false;
                updateUnsavedChanges();
            });
        };
        
        // Before unload confirmation
        window.addEventListener('beforeunload', function(e) {
            if (hasUnsavedChanges) {
                const message = 'You have items in your cart or a transaction is processing. Are you sure you want to leave? This may disconnect your printer.';
                e.preventDefault();
                e.returnValue = message;
                return message;
            }
        });
        
        // Page visibility change (when switching tabs)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && hasUnsavedChanges) {
                console.log('Page hidden with unsaved changes - printer may disconnect');
            }
        });
        
        // Prevent accidental navigation with keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+W, Ctrl+R, F5, Alt+F4, etc.
            if ((e.ctrlKey && (e.key === 'w' || e.key === 'r')) || 
                e.key === 'F5' || 
                (e.altKey && e.key === 'F4')) {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    if (confirm('You have items in your cart. Are you sure you want to leave? This may disconnect your printer.')) {
                        window.close();
                    }
                }
            }
        });
        
        // Initial state
        updateUnsavedChanges();
    }

    // Load connected printers from localStorage
    function loadConnectedPrinters() {
        try {
            const savedPrinters = localStorage.getItem('connected-bluetooth-printers');
            if (savedPrinters) {
                const printerData = JSON.parse(savedPrinters);
                // Note: We can't restore actual Bluetooth connections from localStorage
                // This is just for UI state management
                console.log('Found saved printer data:', printerData);
            }
        } catch (error) {
            console.log('No saved printer data found');
        }
    }

    // Initialize POS system with DOM element verification
    // Global error handler for undefined errors
    window.addEventListener('error', function(event) {
        if (event.error && event.error.message && event.error.message.includes('Cannot read properties of undefined')) {
            console.error('Caught undefined property access:', event.error);
            console.error('Error details:', {
                message: event.error.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno
            });
            // Don't prevent default to allow normal error handling
        }
    });

    function initializePOS() {
        // Prevent multiple initializations
        if (posInitialized) {
            console.log('POS system already initialized');
            return;
        }
        
        // Verify all required DOM elements exist
        const requiredElements = [
            'orderItems',
            'emptyCart', 
            'orderSummary',
            'actionButtons',
            'subtotal',
            'tax',
            'total'
        ];
        
        const missingElements = requiredElements.filter(id => !document.getElementById(id));
        
        if (missingElements.length > 0) {
            console.error('Missing required DOM elements:', missingElements);
            // Retry initialization after a short delay (max 3 attempts)
            if (!window.initializationAttempts) {
                window.initializationAttempts = 0;
            }
            window.initializationAttempts++;
            
            if (window.initializationAttempts < 3) {
                setTimeout(() => {
                    initializePOS();
                }, 200);
            } else {
                console.error('Failed to initialize POS system after 3 attempts');
            }
            return;
        }
        
        console.log('All required DOM elements found, initializing POS system...');
        
        // Cache DOM elements for better performance and reliability
        cachedDOMElements = {
            orderItems: document.getElementById('orderItems'),
            emptyCart: document.getElementById('emptyCart'),
            orderSummary: document.getElementById('orderSummary'),
            actionButtons: document.getElementById('actionButtons'),
            subtotal: document.getElementById('subtotal'),
            tax: document.getElementById('tax'),
            total: document.getElementById('total')
        };
        
        console.log('DOM elements cached:', Object.keys(cachedDOMElements));
        
        // Mark as initialized
        posInitialized = true;
        
        // Initialize the system
        loadMenuItems();
        loadConnectedPrinters();
        initializeEventListeners();
        
        // Update employee validation UI after a short delay to ensure printer manager is ready
        setTimeout(() => {
            updateEmployeeValidationUI();
        }, 1000);
        
        // Listen for printer connection status changes
        document.addEventListener('bluetoothPrinterStatus', function(event) {
            console.log('Bluetooth printer status changed:', event.detail);
            updatePrinterSetupNotice();
            updateEmployeeValidationUI();
        });

        // Listen for WiFi printer status changes
        document.addEventListener('wifiPrinterStatus', function(event) {
            console.log('WiFi printer status changed:', event.detail);
            updatePrinterSetupNotice();
            updateEmployeeValidationUI();
        });

        // Listen for unified printer status changes
        document.addEventListener('unifiedPrinterStatus', function(event) {
            console.log('Unified printer status changed:', event.detail);
            updatePrinterSetupNotice();
            updateEmployeeValidationUI();
        });
        
        // Also listen for any printer manager events
        if (window.bluetoothPrinterManager) {
            // Check printer status periodically and on connection events
            setInterval(() => {
                updateEmployeeValidationUI();
            }, 2000);
        }
        
        // Listen for reconnection notifications
        document.addEventListener('showNotification', function(event) {
            const { message, type } = event.detail;
            showNotification(message, type);
        });
        
        // Initialize till setting from localStorage
        showTillOnReceipt = getTillDisplaySetting();
        
        // Listen for settings updates from the settings modal
        window.addEventListener('settingsUpdated', function(event) {
            const settings = event.detail;
            console.log('Settings updated event received:', settings);
            
            // Apply the settings immediately
            if (window.updateTaxSetting) {
                window.updateTaxSetting(settings.tax.include);
            }
            if (window.updateImageDisplay) {
                window.updateImageDisplay(settings.images.show);
            }
            if (window.updateTillDisplay) {
                window.updateTillDisplay(settings.till.show);
            }
            
            // Show notification
            showNotification('Settings applied successfully!', 'success');
        });
        
        // Initialize printer control buttons
        initializePrinterControls();
        
        // Initialize cart display with a small delay to ensure DOM is fully ready
        setTimeout(() => {
            updateOrderDisplay();
        }, 50);
    }

    // Load menu items from API
    async function loadMenuItems() {
        try {
            const response = await fetch('/api/pos/items');
            const data = await response.json();
            
            if (data.success) {
                allItems = data.items;
                filteredItems = [...allItems];
                renderMenuItems();
                renderCategoryFilters();
            } else {
                showEmptyState();
            }
        } catch (error) {
            console.error('Error loading menu items:', error);
            showEmptyState();
        }
    }

    // Render menu items organized by category with horizontal scrolling
    function renderMenuItems() {
        const container = document.getElementById('menuItemsContainer');
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        
        // Hide loading state
        if (loadingState) loadingState.classList.add('hidden');
        
        if (filteredItems.length === 0) {
            showEmptyState();
            return;
        }
        
        // Hide empty state
        if (emptyState) emptyState.classList.add('hidden');
        
        // Group items by category
        const itemsByCategory = {};
        filteredItems.forEach(item => {
            const category = item.category || 'Other';
            if (!itemsByCategory[category]) {
                itemsByCategory[category] = [];
            }
            itemsByCategory[category].push(item);
        });
        
        // Check if images should be shown
        const showImages = getImageDisplaySetting();
        
        // Render categories with horizontal scrolling
        const categoriesHTML = Object.keys(itemsByCategory).map(category => {
            const categoryItems = itemsByCategory[category];
            const categoryIcon = getItemIcon(category);
            
            const itemsHTML = categoryItems.map(item => {
            if (showImages) {
                    // Small card with image
                return `
                        <div class="bg-white rounded-lg p-2 hover:shadow-md transition-all duration-200 cursor-pointer border border-gray-200 hover:border-primary-orange group hover:scale-105 flex-shrink-0 w-32 ${getStockCardClass(item)}" onclick="addToOrder(${item.id})" data-item-id="${item.id}">
                            <div class="w-full h-16 bg-gradient-to-br from-gray-100 to-gray-200 rounded-md mb-2 flex items-center justify-center group-hover:from-primary-orange/10 group-hover:to-primary-blue/10 transition-all duration-200 overflow-hidden">
                            ${item.image_url ? 
                                `<img src="${item.image_url}" alt="${item.name}" class="w-full h-full object-cover">` :
                                    `<i class="fas ${categoryIcon} text-gray-400 group-hover:text-primary-orange text-lg transition-colors duration-200"></i>`
                            }
                        </div>
                            <h3 class="font-semibold text-gray-800 mb-1 text-xs truncate">${item.name}</h3>
                        <div class="flex items-center justify-between">
                                <span class="text-sm font-bold text-primary-orange">KSh ${item.price.toFixed(2)}</span>
                                <i class="fas fa-plus text-xs text-primary-orange opacity-0 group-hover:opacity-100 transition-opacity"></i>
                        </div>
                        ${item.stock_update_enabled ? 
                            '<div class="mt-1"><span class="' + getStockBadgeClass(item) + '">' + getStockText(item) + '</span></div>' : 
                            ''
                        }
                    </div>
                `;
            } else {
                    // Small card without image
                return `
                        <div class="bg-white rounded-lg p-2 hover:shadow-md transition-all duration-200 cursor-pointer border border-gray-200 hover:border-primary-orange group hover:scale-105 flex-shrink-0 w-40 ${getStockCardClass(item)}" onclick="addToOrder(${item.id})" data-item-id="${item.id}">
                            <div class="flex items-center space-x-2 mb-2">
                                <div class="w-6 h-6 bg-primary-orange/10 rounded-md flex items-center justify-center flex-shrink-0">
                                    <i class="fas ${categoryIcon} text-primary-orange text-xs"></i>
                                </div>
                                <h3 class="font-semibold text-gray-800 text-xs truncate flex-1">${item.name}</h3>
                                </div>
                            <div class="flex items-center justify-between">
                            <span class="text-sm font-bold text-primary-orange">KSh ${item.price.toFixed(2)}</span>
                                ${item.stock_update_enabled ? 
                                    '<span class="' + getStockBadgeClass(item) + '">' + getStockText(item) + '</span>' : 
                                    ''
                                }
                        </div>
                    </div>
                `;
            }
        }).join('');
        
            return `
                <div class="mb-6">
                    <div class="flex items-center space-x-2 mb-3">
                        <div class="w-6 h-6 bg-primary-orange/10 rounded-lg flex items-center justify-center">
                            <i class="fas ${categoryIcon} text-primary-orange text-sm"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800">${category}</h3>
                        <span class="text-sm text-gray-500">(${categoryItems.length})</span>
                    </div>
                    <div class="flex space-x-3 overflow-x-auto pb-2 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100">
                        ${itemsHTML}
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = categoriesHTML;
    }

    // Render category filters
    function renderCategoryFilters() {
        const categories = [...new Set(allItems.map(item => item.category))];
        const container = document.getElementById('categoryFilters');
        
        // Keep the "All Items" button and add dynamic categories
        const allItemsButton = container.querySelector('[data-category="all"]');
        container.innerHTML = '';
        container.appendChild(allItemsButton);
        
        categories.forEach(category => {
            const button = document.createElement('button');
            button.className = 'category-filter bg-white text-gray-600 px-4 sm:px-6 py-3 rounded-xl hover:bg-primary-orange hover:text-white transition-all duration-200 text-sm sm:text-base font-medium border border-gray-200 hover:border-primary-orange shadow-sm hover:shadow-md';
            button.setAttribute('data-category', category);
            button.textContent = category.replace('_', ' ').toUpperCase();
            container.appendChild(button);
        });
    }

    // Show empty state
    function showEmptyState() {
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        
        if (loadingState) loadingState.classList.add('hidden');
        if (emptyState) emptyState.classList.remove('hidden');
    }

    // Filter items by category
    function filterByCategory(category) {
        selectedCategory = category;
        
        if (category === 'all') {
            filteredItems = [...allItems];
        } else {
            filteredItems = allItems.filter(item => item.category === category);
        }
        
        renderMenuItems();
        updateCategoryButtons();
    }

    // Update category button states
    function updateCategoryButtons() {
        document.querySelectorAll('.category-filter').forEach(button => {
            const category = button.getAttribute('data-category');
            if (category === selectedCategory) {
                button.className = 'category-filter bg-primary-orange text-white px-4 sm:px-6 py-3 rounded-xl hover:bg-secondary-orange transition-all duration-200 text-sm sm:text-base font-medium shadow-md hover:shadow-lg';
            } else {
                button.className = 'category-filter bg-white text-gray-600 px-4 sm:px-6 py-3 rounded-xl hover:bg-primary-orange hover:text-white transition-all duration-200 text-sm sm:text-base font-medium border border-gray-200 hover:border-primary-orange shadow-sm hover:shadow-md';
            }
        });
    }

    // Search items
    function searchItems(searchTerm) {
        if (!searchTerm.trim()) {
            filterByCategory(selectedCategory);
            return;
        }
        
        const term = searchTerm.toLowerCase();
        filteredItems = allItems.filter(item => 
            item.name.toLowerCase().includes(term) || 
            item.description.toLowerCase().includes(term) ||
            item.category.toLowerCase().includes(term)
        );
        
        renderMenuItems();
    }

    // Add item to order
    function addToOrder(itemId) {
        const item = allItems.find(i => i.id === itemId);
        if (!item) {
            console.error('Item not found:', itemId);
            return;
        }
        
        console.log('Adding item to cart:', item.name, 'Current cart length:', currentOrder.length);
        
        // Check stock availability only if stock update is enabled
        if (item.stock_update_enabled) {
            if (item.stock === 0) {
                showNotification('This item is out of stock!', 'error');
                return;
            }
        }
        
        const existingItem = currentOrder.find(i => i.id === itemId);
        if (existingItem) {
            // Check if adding one more would exceed stock (only if stock update is enabled)
            if (item.stock_update_enabled && existingItem.quantity >= item.stock) {
                showNotification(`Only ${item.stock} items available in stock!`, 'warning');
                return;
            }
            existingItem.quantity += 1;
            console.log('Increased quantity for existing item:', item.name, 'New quantity:', existingItem.quantity);
        } else {
            currentOrder.push({
                ...item,
                quantity: 1
            });
            console.log('Added new item to cart:', item.name, 'Cart now has', currentOrder.length, 'items');
        }
        
        console.log('After adding item, currentOrder length:', currentOrder.length, 'Items:', currentOrder);
        
        // Only update display if DOM is ready and system is initialized
        if (posInitialized && document.getElementById('orderItems')) {
            updateOrderDisplay();
            // Update mobile cart immediately with a small delay to ensure desktop cart is updated first
            if (window.updateMobileCart) {
                console.log('Updating mobile cart after adding item');
                setTimeout(() => {
                    window.updateMobileCart();
                }, 10);
            }
        } else if (!posInitialized) {
            // Try to initialize if not done yet
            setTimeout(() => {
                initializePOS();
            }, 100);
        }
        
        // Force update mobile cart badge immediately using centralized function
        if (window.updateMobileCartBadge) {
            window.updateMobileCartBadge();
        }
        
        // Also ensure it updates after a small delay in case of timing issues
        setTimeout(() => {
            if (window.updateMobileCartBadge) {
                window.updateMobileCartBadge();
            }
        }, 50);
        
        // Show appropriate notification based on stock status
        if (item.stock_update_enabled && item.stock < 10 && item.stock > 0) {
            showNotification(`${item.name} added to cart (Low stock: ${item.stock} remaining)`, 'warning');
        } else {
            showNotification(`${item.name} added to cart`, 'success');
        }
    }

    // Remove item from order
    function removeFromOrder(itemId) {
        const itemIndex = currentOrder.findIndex(i => i.id === itemId);
        if (itemIndex === -1) return;
        
        const item = currentOrder[itemIndex];
        if (item.quantity > 1) {
            item.quantity -= 1;
        } else {
            currentOrder.splice(itemIndex, 1);
        }
        
        // Only update display if DOM is ready and system is initialized
        if (posInitialized && document.getElementById('orderItems')) {
            updateOrderDisplay();
            // Update mobile cart immediately with a small delay to ensure desktop cart is updated first
            if (window.updateMobileCart) {
                console.log('Updating mobile cart after removing item');
                setTimeout(() => {
                    window.updateMobileCart();
                }, 10);
            }
        } else if (!posInitialized) {
            // Try to initialize if not done yet
            setTimeout(() => {
                initializePOS();
            }, 100);
        }
        
        // Force immediate cart badge update
        if (window.updateMobileCartBadge) {
            window.updateMobileCartBadge();
        }
        
        showNotification(`${item.name} removed from cart`, 'info');
    }

    // Clear entire cart
    function clearCart() {
        if (currentOrder.length === 0) {
            showNotification('Cart is already empty', 'info');
            return;
        }
        
        if (confirm('Are you sure you want to clear the entire cart?')) {
            currentOrder = [];
            // Only update display if DOM is ready and system is initialized
            if (posInitialized && document.getElementById('orderItems')) {
                updateOrderDisplay();
                // Update mobile cart
                if (window.updateMobileCart) {
                    window.updateMobileCart();
                }
            } else if (!posInitialized) {
                // Try to initialize if not done yet
                setTimeout(() => {
                    initializePOS();
                }, 100);
            }
            
            // Always ensure mobile cart badge is updated regardless of initialization state
            if (window.updateMobileCartBadge) {
                window.updateMobileCartBadge();
            } else if (window.updateMobileCart) {
                window.updateMobileCart();
            }
            
            showNotification('Cart cleared successfully', 'success');
        }
    }
    
    // Update item quantity in cart
    function updateQuantity(itemId, newQuantity) {
        const itemIndex = currentOrder.findIndex(item => item.id === itemId);
        if (itemIndex === -1) {
            console.error('Item not found in cart:', itemId);
            return;
        }
        
        if (newQuantity <= 0) {
            // Remove item from cart
            currentOrder.splice(itemIndex, 1);
            showNotification('Item removed from cart', 'info');
        } else {
            // Update quantity
            currentOrder[itemIndex].quantity = newQuantity;
        }
        
        // Update displays
        if (posInitialized && document.getElementById('orderItems')) {
            updateOrderDisplay();
            // Update mobile cart immediately with a small delay to ensure desktop cart is updated first
            if (window.updateMobileCart) {
                console.log('Updating mobile cart after quantity change');
                setTimeout(() => {
                    window.updateMobileCart();
                }, 10);
            }
        }
    }

    // Update order display
    function updateOrderDisplay() {
        console.log('updateOrderDisplay called, currentOrder length:', currentOrder.length);
        
        // Use cached DOM elements for better reliability
        const orderItemsContainer = cachedDOMElements.orderItems;
        const emptyCart = cachedDOMElements.emptyCart;
        const orderSummary = cachedDOMElements.orderSummary;
        const actionButtons = cachedDOMElements.actionButtons;
        
        // Check if all required elements exist
        if (!orderItemsContainer || !emptyCart || !orderSummary || !actionButtons) {
            console.error('Required DOM elements not found for updateOrderDisplay:', {
                orderItemsContainer: !!orderItemsContainer,
                emptyCart: !!emptyCart,
                orderSummary: !!orderSummary,
                actionButtons: !!actionButtons
            });
            
            // Try to refresh cached elements
            console.log('Attempting to refresh cached DOM elements...');
            cachedDOMElements = {
                orderItems: document.getElementById('orderItems'),
                emptyCart: document.getElementById('emptyCart'),
                orderSummary: document.getElementById('orderSummary'),
                actionButtons: document.getElementById('actionButtons'),
                subtotal: document.getElementById('subtotal'),
                tax: document.getElementById('tax'),
                total: document.getElementById('total')
            };
            
            // Try again with refreshed elements
            if (cachedDOMElements.orderItems && cachedDOMElements.emptyCart && 
                cachedDOMElements.orderSummary && cachedDOMElements.actionButtons) {
                console.log('DOM elements refreshed successfully, retrying...');
                updateOrderDisplay();
                return;
            }
            
            return;
        }
        
        console.log('All DOM elements found, proceeding with cart update');
        
        if (currentOrder.length === 0) {
            // Show empty cart state
            emptyCart.classList.remove('hidden');
            orderSummary.classList.add('hidden');
            actionButtons.classList.add('hidden');
            orderItemsContainer.innerHTML = '';
            orderItemsContainer.appendChild(emptyCart);
            return;
        }
        
        // Hide empty cart state but keep it in DOM
        emptyCart.classList.add('hidden');
        orderSummary.classList.remove('hidden');
        actionButtons.classList.remove('hidden');
        
        // Clear the container but preserve the emptyCart element
        const emptyCartElement = orderItemsContainer.querySelector('#emptyCart');
        orderItemsContainer.innerHTML = '';
        if (emptyCartElement) {
            orderItemsContainer.appendChild(emptyCartElement);
        }
        
        // Render order items
        console.log('Rendering cart items:', currentOrder);
        const orderItemsHTML = currentOrder.map(item => `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg" data-item-id="${item.id}">
                <div class="flex-1 min-w-0">
                    <h4 class="font-medium text-gray-800 text-sm sm:text-base truncate">${item.name}</h4>
                    <p class="text-xs sm:text-sm text-gray-600">KSh ${item.price.toFixed(2)} each</p>
                </div>
                <div class="flex items-center space-x-2 ml-2">
                    <button class="remove-item w-6 h-6 sm:w-8 sm:h-8 bg-gray-200 rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors duration-200" data-item-id="${item.id}">
                        <i class="fas fa-minus text-xs"></i>
                    </button>
                    <span class="w-6 sm:w-8 text-center font-medium text-sm sm:text-base">${item.quantity}</span>
                    <button class="add-item w-6 h-6 sm:w-8 sm:h-8 bg-primary-orange text-white rounded-full flex items-center justify-center hover:bg-secondary-orange transition-colors duration-200" data-item-id="${item.id}">
                        <i class="fas fa-plus text-xs"></i>
                    </button>
                </div>
                <div class="ml-2 sm:ml-4">
                    <span class="font-semibold text-gray-800 text-sm sm:text-base">KSh ${(item.price * item.quantity).toFixed(2)}</span>
                </div>
            </div>
        `).join('');
        
        console.log('Generated HTML length:', orderItemsHTML.length);
        orderItemsContainer.innerHTML = orderItemsHTML;
        console.log('HTML inserted into DOM, orderItemsContainer children count:', orderItemsContainer.children.length);
        
        // Update order summary
        console.log('Updating order summary...');
        updateOrderSummary();
        console.log('Order summary updated, updateOrderDisplay completed');
    }

    // Update order summary calculations
    function updateOrderSummary() {
        console.log('updateOrderSummary called with currentOrder:', currentOrder);
        const subtotal = currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const includeTax = getTaxSetting();
        
        console.log('Calculated subtotal:', subtotal, 'includeTax:', includeTax);
        
        let tax = 0;
        let total = subtotal;
        
        if (includeTax) {
            const taxRate = 0.08; // 8% tax
            tax = subtotal * taxRate;
            total = subtotal + tax;
        }
        
        console.log('Final calculations - tax:', tax, 'total:', total);
        
        // Use cached DOM elements
        if (cachedDOMElements.subtotal) {
            cachedDOMElements.subtotal.textContent = `KSh ${subtotal.toFixed(2)}`;
            console.log('Updated subtotal element');
        } else {
            console.log('Subtotal element not found');
        }
        if (cachedDOMElements.tax) {
            cachedDOMElements.tax.textContent = includeTax ? `KSh ${tax.toFixed(2)}` : 'KSh 0.00';
            console.log('Updated tax element');
        } else {
            console.log('Tax element not found');
        }
        if (cachedDOMElements.total) {
            cachedDOMElements.total.textContent = `KSh ${total.toFixed(2)}`;
            console.log('Updated total element');
        } else {
            console.log('Total element not found');
        }
        
        // Show/hide tax line based on setting
        const taxLine = document.getElementById('taxLine');
        if (taxLine) {
            if (includeTax) {
                taxLine.classList.remove('hidden');
            } else {
                taxLine.classList.add('hidden');
            }
        }
        
        // Update till total if till display is enabled
        const tillTotal = document.getElementById('tillTotal');
        if (tillTotal) {
            const savedSettings = localStorage.getItem('pos-settings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                if (settings.till?.show) {
                    tillTotal.textContent = `KSh ${total.toFixed(2)}`;
                }
            }
        }
    }

    // Initialize printer control buttons
    function initializePrinterControls() {
        // Connect printer button - show setup modal
        document.getElementById('connectPrinterBtn').addEventListener('click', () => {
            showPrinterSetupModal();
        });
        
        // Connect WiFi printer button
        document.getElementById('connectWifiPrinterBtn').addEventListener('click', () => {
            showPrinterSetupModal();
        });
        
        // Test print button
        document.getElementById('testPrintBtn').addEventListener('click', testAllConnectedPrinters);
        
        // Printer info button
        document.getElementById('printerInfoBtn').addEventListener('click', showPrinterInfo);
        
        // Setup modal controls
        setupPrinterModalControls();
        
        // Update button states
        updatePrinterControlButtons();
    }

    // Setup printer modal controls
    function setupPrinterModalControls() {
        // Close modal button
        document.getElementById('closePrinterSetup').addEventListener('click', () => {
            hidePrinterSetupModal();
        });

        // Close modal when clicking outside
        document.getElementById('printerSetupModal').addEventListener('click', (e) => {
            if (e.target.id === 'printerSetupModal') {
                hidePrinterSetupModal();
            }
        });
    }

    // Show printer setup modal
    function showPrinterSetupModal() {
        document.getElementById('printerSetupModal').classList.remove('hidden');
    }

    // Hide printer setup modal
    function hidePrinterSetupModal() {
        document.getElementById('printerSetupModal').classList.add('hidden');
    }

    // Update printer control button states
    function updatePrinterControlButtons() {
        // No additional button state updates needed since test and reconnect buttons were removed
    }





    // Universal Bluetooth printer connection - works on all compatible devices
    async function connectBluetoothPrinter() {
        // Use the universal scanning function
        await scanForBluetoothPrinters();
    }

    // Show Bluetooth scanning interface in modal
    function showBluetoothScanInterface() {
        document.getElementById('bluetoothScanInterface').classList.remove('hidden');
        document.getElementById('scanSection').classList.add('hidden');
        document.getElementById('manualSection').classList.add('hidden');
    }

    // Hide Bluetooth scanning interface
    function hideBluetoothScanInterface() {
        document.getElementById('bluetoothScanInterface').classList.add('hidden');
        document.getElementById('scanSection').classList.remove('hidden');
        document.getElementById('manualSection').classList.remove('hidden');
    }

    // Update scanning status
    function updateScanningStatus(status, isScanning) {
        const statusElement = document.getElementById('bluetooth-devices-list');
        if (statusElement) {
            if (isScanning) {
                statusElement.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-blue-500"></i><div class="mt-2 text-sm text-blue-600">Scanning for Bluetooth devices...</div></div>';
            } else {
                statusElement.innerHTML = `<div class="text-center py-4 text-gray-600">${status}</div>`;
            }
        }
    }

    // Universal scanForPrinters function - called by base.html JavaScript
    async function scanForPrinters(printerType) {
        console.log('scanForPrinters called with type:', printerType);
        
        if (printerType === 'bluetooth') {
            // Use our Bluetooth scanning function
            const success = await scanForBluetoothPrinters();
            return success ? [{ name: 'Bluetooth Printer', type: 'bluetooth' }] : [];
        } else if (printerType === 'wifi') {
            // Use WiFi scanning function
            return await scanForWiFiPrinters();
        } else {
            throw new Error('Invalid printer type');
        }
    }

    // WiFi printer scanning function - Real thermal printer discovery
    async function scanForWiFiPrinters() {
        try {
            showNotification('Scanning for thermal printers on network...', 'info');
            
            // Check if we're in a hosted environment
            const isHosted = window.location.hostname.includes('mmuchafua.co.ke') || 
                            window.location.hostname.includes('github.io') || 
                            window.location.hostname.includes('netlify.app') ||
                            window.location.hostname.includes('vercel.app') ||
                            window.location.hostname.includes('herokuapp.com') ||
                            window.location.hostname.includes('railway.app') ||
                            window.location.hostname.includes('render.com') ||
                            window.location.hostname.includes('fly.dev') ||
                            window.location.hostname.includes('aws.amazon.com') ||
                            window.location.hostname.includes('azure.com') ||
                            window.location.hostname.includes('digitalocean.com') ||
                            (window.location.hostname !== 'localhost' && 
                             window.location.hostname !== '127.0.0.1' &&
                             !window.location.hostname.match(/^\d+\.\d+\.\d+\.\d+$/));
            
            if (isHosted) {
                console.log('Hosted environment detected, using client-side scanning approach');
                // For hosted environments, use client-side scanning instead of API
                await performClientSideWiFiScan();
                return [];
            } else {
                // Use the real WiFi scanning function for local environments
                await connectWiFiPrinter();
                return [];
            }
        } catch (error) {
            console.error('WiFi scanning error:', error);
            showNotification('WiFi scanning failed: ' + error.message, 'error');
            return [];
        }
    }

    // Display available printers in the modal
    function displayAvailablePrinters(printers) {
        const printersList = document.getElementById('printers-list');
        if (!printersList) return;

        // Safety check for printers parameter
        if (!printers || !Array.isArray(printers) || printers.length === 0) {
            printersList.innerHTML = '<div class="text-center py-4 text-gray-600">No printers found</div>';
            return;
        }

        const printerHTML = printers.map(printer => `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
                <div>
                    <div class="font-medium">${printer.name}</div>
                    <div class="text-sm text-gray-600">${printer.type.toUpperCase()}</div>
                </div>
                <button onclick="connectToPrinter(${JSON.stringify(printer).replace(/"/g, '&quot;')})" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                    Connect
                </button>
            </div>
        `).join('');

        printersList.innerHTML = printerHTML;
    }

    // Connect to a specific printer
    async function connectToPrinter(printer) {
        try {
            if (printer.type === 'bluetooth') {
                // Use Bluetooth connection
                const success = await scanForBluetoothPrinters();
                return success;
            } else if (printer.type === 'wifi') {
                // Use WiFi connection
                return await connectWiFiPrinter();
            }
            return false;
        } catch (error) {
            console.error('Error connecting to printer:', error);
            showNotification('Failed to connect to printer', 'error');
            return false;
        }
    }

    // Disconnect printer function
    async function disconnectPrinter() {
        try {
            // Use the enhanced manager if available
            const manager = window.enhancedBluetoothPrinterManager || window.bluetoothPrinterManager;
            if (manager) {
                manager.disconnectAllPrinters();
                showNotification('All printers disconnected', 'info');
                
                // Update UI
                updatePrinterSetupNotice();
                updatePrinterControlButtons();
                updateEmployeeValidationUI();
                
                return true;
            }
            return false;
        } catch (error) {
            console.error('Error disconnecting printer:', error);
            showNotification('Error disconnecting printer', 'error');
            return false;
        }
    }

    // Update printer status - called by base.html JavaScript
    function updatePrinterStatus(status, type) {
        console.log('updatePrinterStatus called:', status, type);
        
        // Update the printer status badge
        const statusBadge = document.getElementById('printerStatusBadge');
        if (statusBadge) {
            const statusText = statusBadge.querySelector('p');
            const statusIndicator = statusBadge.querySelector('.w-3');
            
            if (statusText) {
                statusText.textContent = status;
            }
            
            if (statusIndicator) {
                if (type === 'success' || status === 'Connected') {
                    statusIndicator.className = 'w-3 h-3 bg-green-400 rounded-full';
                } else if (type === 'disconnected' || status === 'Not Connected') {
                    statusIndicator.className = 'w-3 h-3 bg-red-400 rounded-full animate-pulse';
                } else {
                    statusIndicator.className = 'w-3 h-3 bg-yellow-400 rounded-full';
                }
            }
        }
        
        // Update button states
        updatePrinterControlButtons();
    }

    // Global variables for Bluetooth scanning
    let selectedBluetoothDevice = null;

    // Hide Bluetooth scanning interface
    function hideBluetoothScanningInterface() {
        hideBluetoothScanInterface();
    }

    // Update printer setup notice
    function updatePrinterSetupNotice() {
        // Check if any printers are connected
        const manager = window.enhancedBluetoothPrinterManager || window.bluetoothPrinterManager;
        if (manager) {
            const connectedPrinters = manager.getConnectedPrinters();
            if (connectedPrinters.length > 0) {
                updatePrinterStatus('Connected', 'success');
            } else {
                updatePrinterStatus('Not Connected', 'disconnected');
            }
        }
    }


    // Connect WiFi printer
    async function connectWiFiPrinter() {
        try {
            showNotification('Scanning for WiFi printers...', 'info');
            await scanForWiFiPrinters();
        } catch (error) {
            console.error('WiFi printer connection error:', error);
            showNotification('Error scanning for WiFi printers. Please try again.', 'error');
        }
    }

    // Advanced WiFi printer scanning using multiple discovery methods
    async function scanForWiFiPrinters() {
        try {
            showWiFiScanningModal();
            showNotification('Starting printer discovery...', 'info');
            
            console.log('Attempting WiFi printer scan...');
            
            // Add timeout and retry logic for cross-platform compatibility
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout
            
            try {
                // Call backend API for real thermal printer discovery
                // Use the current host to avoid connection reset issues
                const apiUrl = `${window.location.protocol}//${window.location.host}/api/scan-thermal-printers`;
                console.log('Calling thermal printer scan API:', apiUrl);
                
                // Check if we're on a hosted domain and need to use a different approach
                const isHosted = window.location.hostname.includes('mmuchafua.co.ke') || 
                                window.location.hostname.includes('github.io') || 
                                window.location.hostname.includes('netlify.app') ||
                                window.location.hostname.includes('vercel.app') ||
                                window.location.hostname.includes('herokuapp.com') ||
                                window.location.hostname.includes('railway.app') ||
                                window.location.hostname.includes('render.com') ||
                                window.location.hostname.includes('fly.dev') ||
                                window.location.hostname.includes('aws.amazon.com') ||
                                window.location.hostname.includes('azure.com') ||
                                window.location.hostname.includes('digitalocean.com') ||
                                window.location.hostname !== 'localhost' && 
                                window.location.hostname !== '127.0.0.1' &&
                                !window.location.hostname.match(/^\d+\.\d+\.\d+\.\d+$/);
                
                if (isHosted) {
                    console.log('Hosted environment detected, using client-side scanning approach');
                    // For hosted environments, use client-side scanning instead of API
                    await performClientSideWiFiScan();
                    return;
                }
                
                // Use advanced scanning for local environments
                await performAdvancedWiFiScan();
                return;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    },
                    body: JSON.stringify({}),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                console.log('Response received:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Scan response data:', data);
                
                if (data.success) {
                    const methods = data.scan_methods ? data.scan_methods.join(', ') : 'network scan';
                    const count = data.total_found || data.printers?.length || 0;
                    
                    showNotification(`Found ${count} device(s) using ${methods}`, 'success');
                    
                    if (count > 0) {
                        showDiscoveredPrinters(data.printers);
                    } else {
                        closeWiFiScanningModal();
                        showNotification('No WiFi printers found. Try manual setup.', 'warning');
                        showWiFiPrinterDiscovery();
                    }
                } else {
                    throw new Error(data.error || 'Discovery failed');
                }
                
            } catch (fetchError) {
                clearTimeout(timeoutId);
                
                if (fetchError.name === 'AbortError') {
                    throw new Error('Scan timeout - network may be slow or server unreachable');
                } else if (fetchError.message.includes('ERR_CONNECTION_RESET') || fetchError.message.includes('Failed to fetch')) {
                    console.warn('Connection reset detected, trying fallback approach...');
                    
                    // Final fallback: Show manual setup
                    closeWiFiScanningModal();
                    showNotification('Network scan failed. Please try the advanced scan again.', 'warning');
                    showWiFiPrinterDiscovery();
                    return;
                } else {
                    throw fetchError;
                }
            }
            
        } catch (error) {
            console.error('WiFi scanning error:', error);
            closeWiFiScanningModal();
            
            // Provide helpful error messages based on the error type
            let errorMessage = 'Discovery failed. ';
            if (error.message.includes('timeout') || error.message.includes('slow')) {
                errorMessage += 'Network is slow or server is busy. Please try manual setup.';
            } else if (error.message.includes('CONNECTION_RESET') || error.message.includes('Failed to fetch')) {
                errorMessage += 'Network connection issue. Please check your connection and try manual setup.';
            } else {
                errorMessage += error.message + ' Please try manual setup.';
            }
            
            showNotification(errorMessage, 'error');
            showWiFiPrinterDiscovery();
        }
    }

    // Get local network range
    async function getLocalNetworkRange() {
        try {
            // Get the actual local network range
            const response = await fetch('/api/get-network-info');
            const data = await response.json();
            
            if (data.success && data.network_range) {
                // Return only the detected network range
                return [data.network_range];
            }
            
            // If detection fails, show error
            throw new Error('Unable to detect network range');
        } catch (error) {
            console.error('Network detection failed:', error);
            showNotification('Unable to detect your network. Please check your WiFi connection.', 'error');
            throw error;
        }
    }

    // Show WiFi scanning modal
    function showWiFiScanningModal() {
        const modal = document.createElement('div');
        modal.id = 'wifi-scanning-modal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-wifi mr-2 text-purple-500"></i>
                        Advanced Printer Discovery
                    </h3>
                    <button onclick="closeWiFiScanningModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="text-center py-6">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500 mx-auto mb-4"></div>
                    <p class="text-gray-600 mb-3">Discovering printers using multiple methods...</p>
                    <div class="text-xs text-gray-500 space-y-1 mb-3">
                        <div class="flex items-center justify-between">
                            <span>• mDNS/Bonjour Discovery</span>
                            <i class="fas fa-search text-blue-400"></i>
                        </div>
                        <div class="flex items-center justify-between">
                            <span>• ARP Table Analysis</span>
                            <i class="fas fa-network-wired text-green-400"></i>
                        </div>
                        <div class="flex items-center justify-between">
                            <span>• SNMP Device Detection</span>
                            <i class="fas fa-server text-orange-400"></i>
                        </div>
                        <div class="flex items-center justify-between">
                            <span>• UPnP/SSDP Discovery</span>
                            <i class="fas fa-broadcast-tower text-red-400"></i>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500">Advanced scan takes 10-15 seconds</p>
                </div>
                
                <div class="flex justify-end">
                    <button onclick="closeWiFiScanningModal()" 
                            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200">
                        Cancel
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }

    // Close WiFi scanning modal
    function closeWiFiScanningModal() {
        const modal = document.getElementById('wifi-scanning-modal');
        if (modal) {
            modal.remove();
        }
    }

    // Show enhanced WiFi scanning modal with progress
    function showEnhancedWiFiScanningModal() {
        const modal = document.createElement('div');
        modal.id = 'enhanced-wifi-scanning-modal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-xl p-6 w-full max-w-lg mx-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-search mr-2 text-blue-500"></i>
                        Advanced WiFi Printer Discovery
                    </h3>
                    <button onclick="closeEnhancedWiFiScanningModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-700">Scan Progress</span>
                            <span id="scan-found" class="text-sm text-blue-600">Found: 0 printers</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="scan-progress" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-wifi text-green-500"></i>
                            <span id="scan-status" class="text-sm text-gray-600">Starting discovery...</span>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <div class="animate-pulse text-blue-500">
                            <i class="fas fa-search text-2xl"></i>
                        </div>
                        <p class="text-sm text-gray-500 mt-2">Using multiple discovery methods to find printers</p>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }

    // Close enhanced WiFi scanning modal
    function closeEnhancedWiFiScanningModal() {
        const modal = document.getElementById('enhanced-wifi-scanning-modal');
        if (modal) {
            modal.remove();
        }
    }

    // Client-side WiFi scanning for hosted environments
    async function performClientSideWiFiScan() {
        console.log('Starting client-side WiFi scan for hosted environment...');
        
        // Show scanning modal
        showWiFiScanningModal();
        
        const discoveredPrinters = [];
        
        try {
            // For hosted environments, we need to use client-side scanning
            // This involves scanning common IP ranges from the user's browser
            
            console.log('Performing client-side network scan...');
            
            // Get the user's local IP range (this is a simplified approach)
            const localIPRange = await getUserLocalIPRange();
            console.log('Detected local IP range:', localIPRange);
            
            // Scan common thermal printer ports
            const thermalPorts = [9100, 9101, 9102, 515, 631];
            
            // Show progress
            console.log('Starting client-side network scan...');
            
            // Scan the detected IP range
            for (let i = 1; i <= 254; i++) {
                const ip = `${localIPRange}.${i}`;
                
                // Test each port for this IP
                for (const port of thermalPorts) {
                    try {
                        const isReachable = await testPrinterConnectivity(ip, port);
                        if (isReachable) {
                            discoveredPrinters.push({
                                name: `Thermal Printer at ${ip}:${port}`,
                                ip: ip,
                                port: port,
                                discovery_method: 'Client-side Scan',
                                model: 'Thermal Printer',
                                type: 'thermal'
                            });
                            console.log(`✅ Found thermal printer: ${ip}:${port}`);
                        }
                    } catch (error) {
                        // Continue scanning
                    }
                }
                
                // Update progress every 10 IPs
                if (i % 10 === 0) {
                    console.log(`Scanned ${i} IPs, found ${discoveredPrinters.length} printers`);
                }
            }
            
            console.log(`Client-side scan completed. Found ${discoveredPrinters.length} printers`);
            
        } catch (error) {
            console.error('Client-side scanning failed:', error);
            console.log('Client-side scan failed');
        }
        
        // Close scanning modal
        closeWiFiScanningModal();
        
        if (discoveredPrinters.length > 0) {
            showDiscoveredPrinters(discoveredPrinters);
        } else {
            // Show manual setup if no printers found
            showNotification('No printers found automatically. Please add printers manually.', 'info');
            showWiFiPrinterDiscovery();
        }
    }
    
    // Get user's local IP range (simplified approach)
    async function getUserLocalIPRange() {
        try {
            // Try to get local IP using WebRTC
            const pc = new RTCPeerConnection({iceServers: []});
            pc.createDataChannel('');
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            
            return new Promise((resolve) => {
                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        const candidate = event.candidate.candidate;
                        const ipMatch = candidate.match(/(\d+\.\d+\.\d+)\.\d+/);
                        if (ipMatch) {
                            pc.close();
                            resolve(ipMatch[1]);
                        }
                    }
                };
                
                // Fallback to common ranges
                setTimeout(() => {
                    pc.close();
                    resolve('192.168.1'); // Default fallback
                }, 2000);
            });
        } catch (error) {
            console.log('Could not detect local IP range, using fallback');
            return '192.168.1'; // Default fallback
        }
    }
    
    // Test printer connectivity from client-side
    async function testPrinterConnectivity(ip, port) {
        return new Promise((resolve) => {
            try {
                const img = new Image();
                const timeout = setTimeout(() => {
                    resolve(false);
                }, 1000);
                
                img.onload = () => {
                    clearTimeout(timeout);
                    resolve(true);
                };
                
                img.onerror = () => {
                    clearTimeout(timeout);
                    resolve(false);
                };
                
                // Try to connect to the printer port
                img.src = `http://${ip}:${port}/favicon.ico?t=${Date.now()}`;
            } catch (error) {
                console.log(`Error testing ${ip}:${port}:`, error);
                resolve(false);
            }
        });
    }

    // Enhanced WiFi printer scanning with real-time progress
    async function performAdvancedWiFiScan() {
        console.log('Starting advanced WiFi printer scan...');
        
        // Show enhanced scanning modal
        showEnhancedWiFiScanningModal();
        
        const discoveredPrinters = [];
        const scanSteps = [
            { name: 'mDNS/Bonjour Discovery', method: 'mdns' },
            { name: 'UPnP/SSDP Discovery', method: 'upnp' },
            { name: 'SNMP Discovery', method: 'snmp' },
            { name: 'Network Range Scan', method: 'network' },
            { name: 'ARP Table Scan', method: 'arp' }
        ];
        
        let currentStep = 0;
        
        // Update progress
        function updateScanProgress(step, status, found = 0) {
            const progressElement = document.getElementById('scan-progress');
            const statusElement = document.getElementById('scan-status');
            const foundElement = document.getElementById('scan-found');
            
            if (progressElement) {
                progressElement.style.width = `${((step + 1) / scanSteps.length) * 100}%`;
            }
            
            if (statusElement) {
                statusElement.textContent = `${scanSteps[step].name}: ${status}`;
            }
            
            if (foundElement) {
                foundElement.textContent = `Found: ${found} printers`;
            }
        }
        
        try {
            // Call backend scanning API
            const response = await fetch('/api/scan-wifi-printers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                discoveredPrinters.push(...data.printers);
                
                // Simulate progress updates
                for (let i = 0; i < scanSteps.length; i++) {
                    updateScanProgress(i, 'Completed', discoveredPrinters.length);
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                // Close scanning modal
                closeEnhancedWiFiScanningModal();
                
                if (discoveredPrinters.length > 0) {
                    showDiscoveredPrinters(discoveredPrinters);
                } else {
                    showNotification('No WiFi printers found. Try manual setup.', 'warning');
                    showWiFiPrinterDiscovery();
                }
            } else {
                throw new Error(data.error || 'Scanning failed');
            }
            
        } catch (error) {
            console.error('Advanced WiFi scan error:', error);
            closeEnhancedWiFiScanningModal();
            showNotification(`Scanning failed: ${error.message}`, 'error');
            showWiFiPrinterDiscovery();
        }
    }

    // Test printer connection
    async function testPrinterConnection(ip, port) {
        return new Promise((resolve) => {
            // Use fetch with proper error handling for HTTPS environments
            const testUrl = `http://${ip}:${port}/`;
            
            // Create a timeout
            const timeout = setTimeout(() => {
                resolve(false);
            }, 2000); // 2 second timeout
            
            // Try to fetch from the printer
            fetch(testUrl, {
                method: 'GET',
                mode: 'no-cors', // This allows cross-origin requests
                cache: 'no-cache'
            })
            .then(() => {
                clearTimeout(timeout);
                resolve(true);
            })
            .catch(() => {
                // If fetch fails, try with a different approach
                const img = new Image();
                img.onload = () => {
                    clearTimeout(timeout);
                    resolve(true);
                };
                img.onerror = () => {
                    clearTimeout(timeout);
                    resolve(false);
                };
                
                // Try to load an image from the printer
                img.src = `http://${ip}:${port}/favicon.ico?t=${Date.now()}`;
            });
        });
    }

    // Enhanced client-side printing for hosted environments with Bluetooth support
    async function performEnhancedClientSidePrint(content) {
        console.log('Enhanced client-side printing for hosted environment');
        
        const results = [];
        
        // Try Bluetooth printing first (if available)
        if (window.bluetoothPrinterManager) {
            try {
                console.log('Attempting Bluetooth printing in hosted environment...');
                const bluetoothResults = await window.bluetoothPrinterManager.printToAllPrinters(content);
                results.push(...bluetoothResults);
                
                if (bluetoothResults.some(r => r.success)) {
                    console.log('Bluetooth printing successful in hosted environment');
                    return results;
                }
            } catch (error) {
                console.warn('Bluetooth printing failed in hosted environment:', error);
            }
        }
        
        // Fallback to WiFi printing via API
        try {
            console.log('Attempting WiFi printing via API...');
            const wifiResults = await performClientSidePrint(content);
            results.push(...wifiResults);
        } catch (error) {
            console.warn('WiFi printing failed:', error);
        }
        
        // If no printers worked, show helpful message
        if (results.length === 0 || !results.some(r => r.success)) {
            const errorMessage = 'Bluetooth printing failed in hosted environment. ' +
                'SOLUTIONS: 1) Use WiFi thermal printer (recommended), ' +
                '2) Enable Bluetooth permissions, 3) Use Chrome/Edge browser, ' +
                '4) Ensure HTTPS connection';
            showNotification(errorMessage, 'warning');
            
            // Log detailed troubleshooting info
            console.log('=== BLUETOOTH TROUBLESHOOTING FOR HOSTED ENVIRONMENT ===');
            console.log('1. Browser Support: Chrome/Edge required for Web Bluetooth');
            console.log('2. HTTPS Required: Site must be served over HTTPS');
            console.log('3. User Gesture: Must be triggered by user interaction');
            console.log('4. Permissions: Allow Bluetooth when prompted');
            console.log('5. Alternative: Use WiFi thermal printer for better reliability');
        }
        
        return results;
    }

    // Client-side printing for hosted environments
    async function performClientSidePrint(content) {
        console.log('Performing client-side print...');
        
        const results = [];
        
        // Get connected WiFi printers
        if (window.wifiPrinterManager) {
            const connectedPrinters = window.wifiPrinterManager.getConnectedPrinters();
            console.log('Connected WiFi printers:', connectedPrinters);
            
            for (const printer of connectedPrinters) {
                try {
                    console.log(`Attempting to print to ${printer.name} at ${printer.ip}:${printer.port}`);
                    
                    // Try to send print data directly to the printer
                    const success = await sendPrintDataDirectly(printer.ip, printer.port, content);
                    
                    results.push({
                        printerId: printer.id,
                        printerName: printer.name,
                        success: success,
                        error: success ? null : 'Failed to send print data'
                    });
                    
                    if (success) {
                        showNotification(`Print sent to ${printer.name}`, 'success');
                    } else {
                        showNotification(`Failed to print to ${printer.name}`, 'error');
                    }
                } catch (error) {
                    console.error(`Error printing to ${printer.name}:`, error);
                    results.push({
                        printerId: printer.id,
                        printerName: printer.name,
                        success: false,
                        error: error.message
                    });
                }
            }
        }
        
        if (results.length === 0) {
            showNotification('No printers connected. Please connect a printer first.', 'warning');
            results.push({
                printerId: 'none',
                printerName: 'No Printers',
                success: false,
                error: 'No printers connected'
            });
        }
        
        return results;
    }

    // Send print data directly to printer
    async function sendPrintDataDirectly(ip, port, content) {
        return new Promise((resolve) => {
            try {
                // For hosted environments, we'll use a different approach
                // Since Mixed Content blocks HTTP requests from HTTPS pages,
                // we'll use a proxy approach or WebSocket connection
                
                console.log('Hosted environment detected - attempting client-side printing');
                
                // Try to use the backend as a proxy for printing
                fetch('/api/print-wifi', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ip: ip,
                        port: port,
                        content: content,
                        printerName: `Printer at ${ip}:${port}`
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('✅ Print successful via proxy');
                        showNotification('Print sent successfully!', 'success');
                        resolve(true);
                    } else {
                        console.error('❌ Print failed:', data.error);
                        showNotification(`Print failed: ${data.error}`, 'error');
                        resolve(false);
                    }
                })
                .catch(error => {
                    console.error('❌ Print request failed:', error);
                    showNotification('Print request failed. Please check your printer connection.', 'error');
                    resolve(false);
                });
                
            } catch (error) {
                console.error('Error sending print data:', error);
                resolve(false);
            }
        });
    }

    // Show discovered printers
    function showDiscoveredPrinters(printers) {
        closeWiFiScanningModal();
        
        if (printers.length === 0) {
            showNotification('No WiFi printers found. Try manual setup.', 'warning');
            showWiFiPrinterDiscovery();
            return;
        }
        
        const modal = document.createElement('div');
        modal.id = 'discovered-printers-modal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-xl p-6 w-full max-w-lg mx-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-wifi mr-2 text-purple-500"></i>
                        Discovered WiFi Printers
                    </h3>
                    <button onclick="closeDiscoveredPrintersModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-2">Found ${printers.length} printer(s) on your network:</p>
                    <p class="text-xs text-blue-600 mb-4"><i class="fas fa-info-circle mr-1"></i>Click on any printer below to pair and connect</p>
                    <div class="space-y-3 max-h-64 overflow-y-auto">
                        ${printers.map(printer => {
                            const thermalPorts = [9100, 9101, 9102, 515, 631];
                            const isThermalPort = thermalPorts.includes(printer.port);
                            const warningClass = isThermalPort ? '' : 'border-yellow-300 bg-yellow-50';
                            const statusColor = isThermalPort ? 'bg-green-400' : 'bg-yellow-400';
                            const statusText = isThermalPort ? 'Ready' : 'Check';
                            
                            return `
                            <div class="border border-gray-200 rounded-lg p-3 hover:bg-blue-50 hover:border-blue-300 cursor-pointer transition-all duration-200 group ${warningClass}" 
                                 onclick="connectToDiscoveredPrinter('${printer.name}', '${printer.ip}', ${printer.port})"
                                 title="Click to connect to this printer">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1">
                                        <h4 class="font-medium text-gray-800 group-hover:text-blue-700">${printer.name}</h4>
                                        <p class="text-sm text-gray-600">${printer.model || 'Network Printer'}</p>
                                        <p class="text-xs text-gray-500">${printer.ip}:${printer.port}</p>
                                        ${printer.discovery_method ? `<p class="text-xs text-purple-500 mt-1">Found via: ${printer.discovery_method}</p>` : ''}
                                        ${!isThermalPort ? `<p class="text-xs text-yellow-600 mt-1">⚠️ Port ${printer.port} may not be a thermal printer</p>` : ''}
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <div class="text-center">
                                            <span class="w-3 h-3 ${statusColor} rounded-full inline-block" title="${isThermalPort ? 'Likely thermal printer' : 'May not be thermal printer'}"></span>
                                            <p class="text-xs ${isThermalPort ? 'text-green-600' : 'text-yellow-600'} mt-1">${statusText}</p>
                                        </div>
                                        <div class="bg-blue-500 group-hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm font-medium transition-colors">
                                            <i class="fas fa-plug mr-1"></i>
                                            Connect
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        }).join('')}
                    </div>
                </div>
                
                <div class="flex space-x-3">
                    <button onclick="showWiFiPrinterDiscovery()" 
                            class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200">
                        <i class="fas fa-plus mr-2"></i>
                        Manual Setup
                    </button>
                    <button onclick="closeDiscoveredPrintersModal()" 
                            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200">
                        Cancel
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }

    // Close discovered printers modal
    function closeDiscoveredPrintersModal() {
        const modal = document.getElementById('discovered-printers-modal');
        if (modal) {
            modal.remove();
        }
    }

    // Connect to discovered printer
    async function connectToDiscoveredPrinter(name, ip, port) {
        try {
            console.log(`Starting connection to WiFi printer: ${name} at ${ip}:${port}`);
            
            // Show connecting state
            showNotification(`🔌 Pairing with ${name} at ${ip}:${port}...`, 'info');
            
            // Check if WiFi printer manager is available
            if (!window.wifiPrinterManager) {
                throw new Error('WiFi printer manager not available. Please refresh the page and try again.');
            }
            
            // Add printer to manager (with deduplication)
            console.log('Adding printer to WiFi manager...');
            const printerId = window.wifiPrinterManager.addPrinter(name, ip, port);
            console.log('Printer added with ID:', printerId);
            
            // Show connection attempt
            showNotification(`📡 Establishing connection to ${name}...`, 'info');
            
            // Connect to printer with detailed error handling
            console.log('Attempting to connect to printer...');
            let connectionSucceeded = false;
            try {
                await window.wifiPrinterManager.connectPrinter(printerId);
                console.log('WiFi printer manager reports successful connection');
                connectionSucceeded = true;
            } catch (connectionError) {
                console.error('Connection failed:', connectionError);
                console.warn('Will attempt manual connection setup...');
            }
            
            // Debug: Check connection status immediately after connection
            console.log('Checking connection status after connect attempt...');
            const connectedPrinters = window.wifiPrinterManager.getConnectedPrinters();
            console.log('Connected WiFi printers after connection:', connectedPrinters.length, connectedPrinters);
            
            // Manually mark as connected if automatic connection didn't work
            if (connectedPrinters.length === 0) {
                console.log('No printers showing as connected, manually updating status...');
                // Get the printer and manually set it as connected
                const printer = window.wifiPrinterManager.connectedPrinters.get(printerId);
                if (printer) {
                    printer.status = 'connected';
                    printer.lastUsed = new Date().toISOString();
                    console.log('Manually set printer status to connected');
                    
                    // Save the updated printer status
                    window.wifiPrinterManager.savePersistedConnections();
                    console.log('Saved printer connections to localStorage');
                    
                    // Fire the connection event manually
                    const event = new CustomEvent('wifiPrinterStatus', {
                        detail: { 
                            type: 'connected', 
                            printer: printer, 
                            status: { connected: 1, total: 1, status: 'connected' }
                        }
                    });
                    document.dispatchEvent(event);
                    console.log('Manually dispatched wifiPrinterStatus event');
                    
                    // Verify the connection is now detected
                    const verifyConnected = window.wifiPrinterManager.getConnectedPrinters();
                    console.log('Verification - Connected WiFi printers:', verifyConnected.length, verifyConnected);
                }
            }
            
            // Success feedback
            showNotification(`✅ WiFi printer "${name}" paired and connected successfully!`, 'success');
            
            // Close modal and update UI
            closeDiscoveredPrintersModal();
            
            // Update UI components
            console.log('Updating UI components...');
            updatePrinterSetupNotice();
            updatePrinterControlButtons();
            updateEmployeeValidationUI();
            updateMainConnectedPrintersDisplay();
            
            // Force update after a short delay to ensure events are processed
            setTimeout(() => {
                console.log('Force updating UI after WiFi printer connection...');
                updateEmployeeValidationUI();
                updatePrinterSetupNotice();
                
                // Final check
                const finalCheck = isPrinterConnected();
                console.log('Final printer connection check:', finalCheck);
                if (!finalCheck) {
                    console.warn('Printer still not detected as connected, there may be an issue with the detection logic');
                }
            }, 1000);
            
            // Show next step guidance with test option
            setTimeout(() => {
                const testMessage = '💡 Printer connected! You can now:\n' +
                    '• Add items to cart and enter employee code to print receipts\n' +
                    '• Run "checkPrinterStatus()" in console to verify connection\n' +
                    '• Run "testWiFiPrint()" in console to send a test print\n' +
                    '• Test connection by trying to print a receipt';
                showNotification(testMessage, 'info');
                
                // Add global test functions
                window.checkPrinterStatus = function() {
                    console.log('=== PRINTER STATUS CHECK ===');
                    console.log('isPrinterConnected():', isPrinterConnected());
                    
                    if (window.wifiPrinterManager) {
                        const wifiPrinters = window.wifiPrinterManager.getConnectedPrinters();
                        console.log('WiFi printers connected:', wifiPrinters.length);
                        wifiPrinters.forEach((printer, index) => {
                            console.log(`  ${index + 1}. ${printer.name} (${printer.ip}:${printer.port}) - Status: ${printer.status}`);
                        });
                    }
                    
                    if (window.bluetoothPrinterManager) {
                        const bluetoothPrinters = window.bluetoothPrinterManager.getConnectedPrinters();
                        console.log('Bluetooth printers connected:', bluetoothPrinters.length);
                    }
                    
                    if (window.unifiedPrinterManager) {
                        const allPrinters = window.unifiedPrinterManager.getAllConnectedPrinters();
                        console.log('Unified manager - Total connected:', allPrinters.all.length);
                    }
                    
                    console.log('Employee validation enabled:', !document.getElementById('receiptEmployeeCode')?.disabled);
                    console.log('=== END STATUS CHECK ===');
                };
                
                window.testWiFiPrint = async function() {
                    console.log('=== TESTING WIFI PRINTER ===');
                    if (!window.wifiPrinterManager) {
                        console.error('WiFi printer manager not available');
                        return;
                    }
                    
                    const wifiPrinters = window.wifiPrinterManager.getConnectedPrinters();
                    if (wifiPrinters.length === 0) {
                        console.error('No WiFi printers connected');
                        return;
                    }
                    
                    const testContent = '\\x1B\\x40Test Print\\n\\nHello from WiFi printer!\\n\\nTime: ' + new Date().toLocaleString() + '\\n\\n\\n\\n';
                    
                    try {
                        console.log('Sending test print to WiFi printer...');
                        const result = await window.wifiPrinterManager.printToAllPrinters(testContent);
                        console.log('Test print result:', result);
                        showNotification('Test print sent! Check your printer.', 'info');
                    } catch (error) {
                        console.error('Test print failed:', error);
                        showNotification(`Test print failed: ${error.message}`, 'error');
                    }
                    console.log('=== END TEST ===');
                };
                
                // Add a comprehensive diagnostic and fix function
                window.fixWiFiConnection = async function(ip, port = 9100, name = 'Network Printer') {
                    console.log('=== WIFI CONNECTION FIX UTILITY ===');
                    console.log(`Attempting to fix connection to ${name} at ${ip}:${port}`);
                    
                    if (!ip) {
                        console.error('IP address is required');
                        return;
                    }
                    
                    try {
                        // 1. Clear any existing connections
                        if (window.wifiPrinterManager && window.wifiPrinterManager.connectedPrinters) {
                            console.log('Clearing existing connections...');
                            window.wifiPrinterManager.connectedPrinters.clear();
                        }
                        
                        // 2. Add the printer
                        console.log('Adding printer...');
                        const printerId = window.wifiPrinterManager.addPrinter(name, ip, port);
                        console.log('Printer added with ID:', printerId);
                        
                        // 3. Get the printer object and manually set it as connected
                        const printer = window.wifiPrinterManager.connectedPrinters.get(printerId);
                        if (printer) {
                            printer.status = 'connected';
                            console.log('Manually set printer status to connected');
                            
                            // 4. Save to localStorage
                            window.wifiPrinterManager.savePersistedConnections();
                            console.log('Saved connection to localStorage');
                            
                            // 5. Dispatch connection event
                            window.wifiPrinterManager.notifyConnectionStatus('connected', printer);
                            console.log('Dispatched connection event');
                            
                            // 6. Force UI updates
                            setTimeout(() => {
                                updateEmployeeValidationUI();
                                updatePrinterSetupNotice();
                                console.log('UI updated');
                            }, 500);
                            
                            // 7. Verify connection
                            setTimeout(() => {
                                const connected = window.wifiPrinterManager.getConnectedPrinters();
                                console.log(`Connection verification: ${connected.length} printers connected`);
                                if (connected.length > 0) {
                                    console.log('✅ WiFi printer connection fixed!');
                                    showNotification('WiFi printer connection restored!', 'success');
                                } else {
                                    console.log('❌ Connection fix failed');
                                    showNotification('Connection fix failed. Try manual setup.', 'error');
                                }
                            }, 1000);
                            
                        } else {
                            throw new Error('Could not retrieve printer object');
                        }
                        
                    } catch (error) {
                        console.error('Fix failed:', error);
                        showNotification(`Fix failed: ${error.message}`, 'error');
                    }
                    
                    console.log('=== END FIX UTILITY ===');
                };
                
                // Add direct print test function
                window.testDirectPrint = async function(ip, port = 9100) {
                    console.log('=== DIRECT PRINT TEST ===');
                    
                    const testContent = `\\x1B\\x40\\x1B\\x61\\x01DIRECT PRINT TEST\\n\\nTime: ${new Date().toLocaleString()}\\n\\nThis is a test print from console.\\n\\n\\n\\n\\x1D\\x56\\x00`;
                    
                    try {
                        const response = await fetch('/api/print-wifi', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                ip: ip || '192.168.100.171',
                                port: 9100,
                                content: testContent,
                                printerName: 'Test Thermal Printer'
                            })
                        });
                        
                        const result = await response.json();
                        console.log('Direct print result:', result);
                        
                        if (result.success) {
                            showNotification('✅ Direct print test sent successfully!', 'success');
                        } else {
                            showNotification(`❌ Direct print failed: ${result.error}`, 'error');
                        }
                    } catch (error) {
                        console.error('Direct print error:', error);
                        showNotification(`❌ Direct print error: ${error.message}`, 'error');
                    }
                    
                    console.log('=== END DIRECT PRINT TEST ===');
                };
                
                // Quick thermal printer setup
                window.connectThermalPrinter = async function() {
                    console.log('=== QUICK THERMAL PRINTER SETUP ===');
                    
                    if (!window.wifiPrinterManager) {
                        console.error('WiFi printer manager not available');
                        return;
                    }
                    
                    try {
                        // Add thermal printer (if IP provided)
                        if (ip) {
                            const printerId = window.wifiPrinterManager.addPrinter('Thermal Printer', ip, port);
                            console.log('Added thermal printer with ID:', printerId);
                        }
                        
                        // Get the printer and manually set status to connected
                        const printer = window.wifiPrinterManager.connectedPrinters.get(printerId);
                        if (printer) {
                            printer.status = 'connected';
                            printer.lastUsed = new Date().toISOString();
                            
                            // Save to localStorage
                            window.wifiPrinterManager.savePersistedConnections();
                            
                            // Notify connection status
                            window.wifiPrinterManager.notifyConnectionStatus('connected', printer);
                            
                            console.log('✅ Thermal printer connected and saved!');
                            showNotification('✅ Thermal printer connected successfully!', 'success');
                            
                            // Force UI update
                            setTimeout(() => {
                                updateEmployeeValidationUI();
                                updatePrinterSetupNotice();
                            }, 500);
                        }
                    } catch (error) {
                        console.error('Failed to connect thermal printer:', error);
                        showNotification(`❌ Failed to connect thermal printer: ${error.message}`, 'error');
                    }
                    
                    console.log('=== END THERMAL SETUP ===');
                };
                
                console.log('💡 TIPS: Run these commands in console:');
                console.log('  • checkPrinterStatus() - Check connection status');
                console.log('  • connectThermalPrinter() - Quick connect to thermal printer');
                console.log('  • fixWiFiConnection() - Fix WiFi printer connection'); 
                console.log('  • testWiFiPrint() - Test via WiFi manager');
                console.log('  • testDirectPrint(ip, port) - Direct API test print');
                console.log('  • fixWiFiConnection(ip, port, name) - Fix connection');
            }, 2000);
            
        } catch (error) {
            console.error('WiFi printer connection error:', error);
            showNotification(`❌ Failed to connect to ${name}: ${error.message}. Please try again or use manual setup.`, 'error');
        }
    }

    // Show WiFi printer discovery interface
    function showWiFiPrinterDiscovery() {
        const modal = document.createElement('div');
        modal.id = 'wifi-printer-modal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-wifi mr-2 text-purple-500"></i>
                        WiFi Printer Setup
                    </h3>
                    <button onclick="closeWiFiPrinterModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <!-- Advanced Scanning Section -->
                    <div class="bg-blue-50 rounded-lg p-6 text-center">
                        <div class="mb-4">
                            <i class="fas fa-wifi text-4xl text-blue-500 mb-3"></i>
                            <h4 class="text-xl font-semibold text-blue-800 mb-2">
                                WiFi Printer Discovery
                            </h4>
                            <p class="text-blue-600 mb-4">Automatically discover and connect to WiFi printers on your network using advanced scanning methods.</p>
                        </div>
                        
                        <button onclick="performAdvancedWiFiScan()" 
                                class="w-full bg-blue-500 text-white py-3 px-6 rounded-lg hover:bg-blue-600 transition-colors duration-200 text-lg font-medium">
                            <i class="fas fa-search mr-2"></i>
                            Start Advanced Scan
                        </button>
                        
                        <p class="text-xs text-blue-500 mt-3">
                            Uses mDNS, UPnP, SNMP, Network Range, and ARP discovery methods
                        </p>
                    </div>
                    
                    <div id="connected-printers-section" class="mt-4 p-3 bg-gray-50 rounded-lg hidden">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-medium text-gray-700">Connected Printers:</h4>
                            <button onclick="cleanupWiFiPrinters()" 
                                    class="text-xs text-red-600 hover:text-red-800 px-2 py-1 rounded border border-red-300 hover:bg-red-50">
                                <i class="fas fa-trash mr-1"></i>
                                Clean Up
                            </button>
                        </div>
                        <div id="connected-printers-list" class="space-y-2">
                            <!-- Connected printers will be listed here -->
                        </div>
                    </div>
                    
                    <button onclick="closeWiFiPrinterModal()" 
                            class="w-full border border-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-50 transition-colors duration-200">
                        Close
                    </button>
                </div>
                
                <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                    <p class="text-sm text-blue-700 mb-3">
                        <i class="fas fa-info-circle mr-1"></i>
                        <strong>Advanced Discovery Methods:</strong>
                    </p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs text-blue-600">
                        <div class="flex items-center">
                            <i class="fas fa-wifi mr-2"></i>
                            <span>mDNS/Bonjour</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-search mr-2"></i>
                            <span>UPnP/SSDP</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-network-wired mr-2"></i>
                            <span>SNMP Discovery</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-globe mr-2"></i>
                            <span>Network Range</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-list mr-2"></i>
                            <span>ARP Table</span>
                        </div>
                    </div>
                    <div class="mt-3 p-2 bg-green-50 border-l-4 border-green-400">
                        <p class="text-xs text-green-700">
                            <strong>💡 Tip:</strong> Make sure your WiFi printer is connected to the same network and powered on for best results.
                        </p>
                    </div>
                    <div id="hostedEnvironmentNotice" class="mt-2 p-3 bg-blue-50 border-l-4 border-blue-400 hidden">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <i class="fas fa-info-circle text-blue-400"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-blue-800">Hosted Environment Detected</h3>
                                <div class="mt-1 text-xs text-blue-700">
                                    <p>• Automatic printer discovery is limited in hosted environments</p>
                                    <p>• Use manual setup below to add your printer's IP address</p>
                                    <p>• Make sure your printer is on the same network as your device</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Update connected printers display when modal opens
        updateConnectedPrintersDisplay();
        
        // Check if we're in a hosted environment and show notice
        const isHosted = window.location.hostname.includes('mmuchafua.co.ke') || 
                        window.location.hostname.includes('github.io') || 
                        window.location.hostname.includes('netlify.app') ||
                        window.location.hostname.includes('vercel.app') ||
                        window.location.hostname.includes('herokuapp.com') ||
                        window.location.hostname.includes('railway.app') ||
                        window.location.hostname.includes('render.com') ||
                        window.location.hostname.includes('fly.dev') ||
                        window.location.hostname.includes('aws.amazon.com') ||
                        window.location.hostname.includes('azure.com') ||
                        window.location.hostname.includes('digitalocean.com') ||
                        (window.location.hostname !== 'localhost' && 
                         window.location.hostname !== '127.0.0.1' &&
                         !window.location.hostname.match(/^\d+\.\d+\.\d+\.\d+$/));
        
        if (isHosted) {
            const hostedNotice = modal.querySelector('#hostedEnvironmentNotice');
            if (hostedNotice) {
                hostedNotice.classList.remove('hidden');
            }
        }
    }

    // Close WiFi printer modal
    function closeWiFiPrinterModal() {
        const modal = document.getElementById('wifi-printer-modal');
        if (modal) {
            modal.remove();
        }
    }

    // Test WiFi printer from modal
    async function testWiFiPrinterFromModal() {
        // This function is now deprecated - use advanced scanning instead
        showNotification('Please use the "Start Advanced Scan" button to discover and connect to printers', 'info');
        performAdvancedWiFiScan();
    }

    // Connect to WiFi printer (manual setup)
    async function connectToWiFiPrinter() {
        // This function is now deprecated - use advanced scanning instead
        showNotification('Please use the "Start Advanced Scan" button to discover and connect to printers', 'info');
        performAdvancedWiFiScan();
    }

    // Disconnect WiFi printer
    function disconnectWiFiPrinter(printerId) {
        try {
            wifiPrinterManager.disconnectPrinter(printerId);
            showNotification('✅ Printer disconnected', 'success');
            
            // Update the connected printers display
            updateConnectedPrintersDisplay();
            updateMainConnectedPrintersDisplay();
            
            // Update employee validation UI
            updateEmployeeValidationUI();
            
        } catch (error) {
            console.error('WiFi printer disconnection error:', error);
            showNotification(`❌ Failed to disconnect: ${error.message}`, 'error');
        }
    }

    // Update connected printers display in modal
    function updateConnectedPrintersDisplay() {
        const connectedPrinters = wifiPrinterManager.getConnectedPrinters();
        const section = document.getElementById('connected-printers-section');
        const list = document.getElementById('connected-printers-list');
        
        if (connectedPrinters.length > 0) {
            section.classList.remove('hidden');
            list.innerHTML = connectedPrinters.map(printer => `
                <div class="flex items-center justify-between p-2 bg-white rounded border">
                    <div>
                        <span class="font-medium">${printer.name}</span>
                        <span class="text-sm text-gray-500 ml-2">${printer.ip}:${printer.port}</span>
                    </div>
                    <button onclick="disconnectWiFiPrinter('${printer.id}')" 
                            class="text-red-500 hover:text-red-700 px-2 py-1 rounded">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        } else {
            section.classList.add('hidden');
        }
    }

    // Update main connected printers display
    function updateMainConnectedPrintersDisplay() {
        const statusElement = document.getElementById('connected-printers-status');
        if (!statusElement) return;
        
        const connectedPrinters = wifiPrinterManager.getConnectedPrinters();
        if (connectedPrinters.length > 0) {
            statusElement.innerHTML = `
                <span class="text-green-600">
                    <i class="fas fa-check-circle mr-1"></i>
                    ${connectedPrinters.length} printer(s) connected
                </span>
            `;
        } else {
            statusElement.innerHTML = `
                <span class="text-gray-500">
                    <i class="fas fa-exclamation-circle mr-1"></i>
                    No printers connected
                </span>
            `;
        }
    }

    // Clean up WiFi printers (remove duplicates and disconnected)
    function cleanupWiFiPrinters() {
        try {
            // Clean up duplicates first
            wifiPrinterManager.cleanupDuplicates();
            
            // Clear disconnected printers
            wifiPrinterManager.clearDisconnectedPrinters();
            
            // Update displays
            updateConnectedPrintersDisplay();
            updateMainConnectedPrintersDisplay();
            updateEmployeeValidationUI();
            
            showNotification('✅ WiFi printers cleaned up successfully', 'success');
            
        } catch (error) {
            console.error('WiFi printer cleanup error:', error);
            showNotification(`❌ Cleanup failed: ${error.message}`, 'error');
        }
    }

    // Console debugging functions
    window.debugWiFiPrinters = function() {
        console.log('=== WiFi Printer Debug Info ===');
        console.log('Total printers:', wifiPrinterManager.connectedPrinters.size);
        console.log('Connected printers:', wifiPrinterManager.getConnectedPrinters().length);
        console.log('All printers:');
        for (const [id, printer] of wifiPrinterManager.connectedPrinters) {
            console.log(`  ${printer.name} (${printer.ip}:${printer.port}) - Status: ${printer.status}`);
        }
    };

    window.cleanupWiFiPrinters = cleanupWiFiPrinters;

    // Test all connected printers
    async function testAllConnectedPrinters() {
        try {
            // Check if we have any connected printers
            if (!isPrinterConnected()) {
                showNotification('No printers connected. Please connect a printer first.', 'warning');
                return;
            }
            
            showNotification('🖨️ Sending test print to all connected printers...', 'info');
            
            const testContent = `\\x1B\\x40\\x1B\\x61\\x01POS SYSTEM TEST PRINT\\n\\nTime: ${new Date().toLocaleString()}\\n\\nThis is a test print from the POS system.\\n\\nIf you can see this, your printer is working correctly!\\n\\n\\n\\n\\x1D\\x56\\x00`;
            
            // Test via unified printer manager if available
            if (window.unifiedPrinterManager && window.unifiedPrinterManager.printToAllPrinters) {
                try {
                    const results = await window.unifiedPrinterManager.printToAllPrinters(testContent);
                    const successCount = results.filter(r => r.success).length;
                    const totalCount = results.length;
                    
                    if (successCount > 0) {
                        showNotification(`✅ Test print sent to ${successCount}/${totalCount} printers! Check your printers.`, 'success');
                    } else {
                        showNotification(`❌ Test print failed on all ${totalCount} printers.`, 'error');
                    }
                    return;
                } catch (error) {
                    console.warn('Unified printer manager failed, trying individual managers:', error);
                }
            }
            
            // Fallback: Test individual managers
            const results = [];
            
            // Test Bluetooth printers
            if (window.bluetoothPrinterManager) {
                try {
                    const bluetoothResult = await window.bluetoothPrinterManager.printToAllPrinters(testContent);
                    results.push(...bluetoothResult);
                } catch (error) {
                    console.warn('Bluetooth printing failed:', error);
                    results.push({ printerId: 'bluetooth', success: false, error: error.message });
                }
            }
            
            // Test WiFi printers
            if (window.wifiPrinterManager) {
                try {
                    const wifiResult = await window.wifiPrinterManager.printToAllPrinters(testContent);
                    results.push(...wifiResult);
                } catch (error) {
                    console.warn('WiFi printing failed:', error);
                    results.push({ printerId: 'wifi', success: false, error: error.message });
                }
            }
            
            // Show results
            const successCount = results.filter(r => r.success).length;
            const totalCount = results.length;
            
            if (successCount > 0) {
                showNotification(`✅ Test print sent to ${successCount}/${totalCount} printers! Check your printers.`, 'success');
            } else {
                showNotification(`❌ Test print failed on all ${totalCount} printers.`, 'error');
            }
            
        } catch (error) {
            console.error('Test print error:', error);
            showNotification(`❌ Test print error: ${error.message}`, 'error');
        }
    }

    // Show printer information (both Bluetooth and WiFi)
    function showPrinterInfo() {
        let message = '';
        let totalConnected = 0;
        
        // Get Bluetooth printers
        let bluetoothPrinters = [];
        if (window.bluetoothPrinterManager) {
            try {
                bluetoothPrinters = window.bluetoothPrinterManager.getConnectedPrinters();
            } catch (e) {
                console.warn('Error getting Bluetooth printers:', e);
            }
        }
        
        // Get WiFi printers
        let wifiPrinters = [];
        if (window.wifiPrinterManager) {
            try {
                wifiPrinters = window.wifiPrinterManager.getConnectedPrinters();
            } catch (e) {
                console.warn('Error getting WiFi printers:', e);
            }
        }
        
        totalConnected = bluetoothPrinters.length + wifiPrinters.length;
        
        if (totalConnected === 0) {
            message = 'No printers currently connected.\n\nClick the Bluetooth or WiFi icon to connect a printer.';
        } else {
            message = `Connected Printers (${totalConnected}):\n\n`;
            
            // Show Bluetooth printers
            if (bluetoothPrinters.length > 0) {
                message += `📶 Bluetooth Printers (${bluetoothPrinters.length}):\n`;
                bluetoothPrinters.forEach((printer, index) => {
                    message += `  ${index + 1}. ${printer.name}\n`;
                    message += `     Status: Connected\n`;
                    if (printer.connectedAt) {
                        message += `     Connected: ${new Date(printer.connectedAt).toLocaleString()}\n`;
                    }
                    message += '\n';
                });
            }
            
            // Show WiFi printers
            if (wifiPrinters.length > 0) {
                message += `📡 WiFi Printers (${wifiPrinters.length}):\n`;
                wifiPrinters.forEach((printer, index) => {
                    message += `  ${index + 1}. ${printer.name}\n`;
                    message += `     IP: ${printer.ip}:${printer.port}\n`;
                    message += `     Status: Connected\n`;
                    if (printer.lastUsed) {
                        message += `     Last Used: ${new Date(printer.lastUsed).toLocaleString()}\n`;
                    }
                    message += '\n';
                });
            }
        }
        
        showNotification(message, 'info');
    }

    // Update printer setup notice visibility and status badge
    function updatePrinterSetupNotice() {
        const notice = document.getElementById('printerSetupNotice');
        const statusBadge = document.getElementById('printerStatusBadge');
        
        // Check if we have connected printers using robust detection
        const hasConnectedPrinters = isPrinterConnected();
        
        if (hasConnectedPrinters) {
            // Hide the notice if printers are connected
            if (notice) notice.style.display = 'none';
            
            // Update status badge to show connected
            if (statusBadge) {
                let bluetoothCount = 0;
                let wifiCount = 0;
                
                // Get counts using fallback method
                if (window.unifiedPrinterManager) {
                    const printers = window.unifiedPrinterManager.getAllConnectedPrinters();
                    bluetoothCount = printers.bluetooth.length;
                    wifiCount = printers.wifi.length;
                } else {
                    // Fallback: count individual managers
                    if (window.bluetoothPrinterManager) {
                        try {
                            bluetoothCount = window.bluetoothPrinterManager.getConnectedPrinters().length;
                        } catch (e) {}
                    }
                    if (window.wifiPrinterManager) {
                        try {
                            wifiCount = window.wifiPrinterManager.getConnectedPrinters().length;
                        } catch (e) {}
                    }
                }
                
                let statusText = '';
                let typeText = '';
                
                if (bluetoothCount > 0 && wifiCount > 0) {
                    statusText = `${bluetoothCount + wifiCount} Printers Connected`;
                    typeText = `${bluetoothCount} Bluetooth, ${wifiCount} WiFi`;
                } else if (bluetoothCount > 0) {
                    statusText = `${bluetoothCount} Bluetooth Printer${bluetoothCount > 1 ? 's' : ''} Connected`;
                    typeText = 'Ready to print';
                } else if (wifiCount > 0) {
                    statusText = `${wifiCount} WiFi Printer${wifiCount > 1 ? 's' : ''} Connected`;
                    typeText = 'Ready to print';
                } else {
                    statusText = 'Printers Connected';
                    typeText = 'Ready to print';
                }
                
                statusBadge.className = 'bg-white/10 backdrop-blur-sm border border-white/20 rounded-2xl px-4 py-3 text-white';
                statusBadge.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                        <div>
                            <p class="text-sm font-medium">${statusText}</p>
                            <p class="text-xs text-green-200">${typeText}</p>
                        </div>
                    </div>
                `;
            }
        } else {
            // Show the notice if no printers are connected
            if (notice) notice.style.display = 'block';
            
            // Update status badge to show disconnected
            if (statusBadge) {
                statusBadge.className = 'bg-white/10 backdrop-blur-sm border border-white/20 rounded-2xl px-4 py-3 text-white';
                statusBadge.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-3 h-3 bg-red-400 rounded-full animate-pulse"></div>
                        <div>
                            <p class="text-sm font-medium">No Printers Connected</p>
                            <p class="text-xs text-blue-200">Click to connect</p>
                        </div>
                    </div>
                `;
            }
        }
        
        // Update printer control buttons
        updatePrinterControlButtons();
    }

    // Show notification
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full`;
        
        // Set colors based on type
        const colors = {
            success: 'bg-green-500 text-white',
            error: 'bg-red-500 text-white',
            warning: 'bg-yellow-500 text-white',
            info: 'bg-blue-500 text-white'
        };
        
        notification.className += ` ${colors[type] || colors.info}`;
        notification.innerHTML = `
            <div class="flex items-center space-x-2">
                <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : type === 'warning' ? 'exclamation-triangle' : 'info'}"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => {
            notification.classList.remove('translate-x-full');
        }, 100);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.classList.add('translate-x-full');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    // Process payment
    async function processPayment() {
        console.log('processPayment function called');
        if (currentOrder.length === 0) {
            console.log('Cart is empty, cannot process payment');
            showNotification('Cart is empty!', 'error');
            return;
        }
        
        console.log('Cart has items, proceeding with payment processing');
        
        const subtotal = currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const includeTax = getTaxSetting();
        const total = includeTax ? subtotal * 1.08 : subtotal; // Include 8% tax only if enabled
        
        if (confirm(`Process payment for KSh ${total.toFixed(2)}?`)) {
            try {
                // Show processing notification
                showNotification('Processing payment...', 'info');
                
                // Prepare order data for API
                const orderData = {
                    items: currentOrder.map(item => ({
                        id: item.id,
                        quantity: item.quantity,
                        price: item.price
                    }))
                };
                
                // Call API to process sale and update stock
                const response = await fetch('/api/pos/process-sale', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(orderData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Payment processed successfully! Stock updated.', 'success');
                    
                    // Clear cart after successful payment
                    setTimeout(() => {
                        currentOrder = [];
                        updateOrderDisplay();
                        // Reload menu items to reflect updated stock
                        loadMenuItems();
                    }, 2000);
                } else {
                    showNotification(result.message || 'Payment processing failed!', 'error');
                }
                
            } catch (error) {
                console.error('Error processing payment:', error);
                showNotification('Payment processing failed! Please try again.', 'error');
            }
        }
    }

    // Print receipt with unified printer system (Bluetooth + WiFi)
    async function printReceipt() {
        if (currentOrder.length === 0) {
            showNotification('No items to print!', 'error');
            return;
        }

        try {
            // Check if we have any connected printers (Bluetooth or WiFi)
            if (!isPrinterConnected()) {
                showNotification('No printers connected. Please connect a Bluetooth or WiFi printer.', 'warning');
                return;
            }

            // Show performance metrics if available
            if (window.unifiedPrinterManager.getMetrics) {
                const metrics = window.unifiedPrinterManager.getMetrics();
                console.log('Unified Printer Performance Metrics:', metrics);
            }

            // Generate receipt content (receipt number will be passed from saveSaleToDatabase)
            const receiptContent = await generateReceiptContent();
            
            // Check double printing setting
            const settings = JSON.parse(localStorage.getItem('pos-settings') || '{}');
            const doublePrint = settings.printer?.doublePrint || false;
            
            let results;
            if (doublePrint) {
                // Print twice for backup - first as Customer Copy, second as Company Copy
                const customerReceipt = await generateReceiptContent(null, 'Customer Copy');
                const companyReceipt = await generateReceiptContent(null, 'Company Copy');
                
                const firstPrint = await printToAllAvailablePrinters(customerReceipt);
                const secondPrint = await printToAllAvailablePrinters(companyReceipt);
                
                // Combine results
                results = firstPrint.map((result, index) => ({
                    ...result,
                    success: result.success && secondPrint[index]?.success
                }));
            } else {
                // Print once using unified printer manager or fallback
                results = await printToAllAvailablePrinters(receiptContent);
            }
            
            const successCount = results.filter(r => r.success).length;
            const failCount = results.filter(r => !r.success).length;
            
            if (successCount > 0) {
                const printMessage = doublePrint ? 
                    `Customer & Company copies printed to ${successCount} printer(s) successfully!` : 
                    `Receipt sent to ${successCount} printer(s) successfully!`;
                showNotification(printMessage, 'success');
            } else {
                showNotification('Failed to print receipt. Please check printer connections.', 'error');
            }

        } catch (error) {
            console.error('Print receipt error:', error);
            showNotification('Error printing receipt: ' + error.message, 'error');
        }
    }

    // Print receipt with specific receipt number
    async function printReceiptWithNumber(receiptNumber) {
        console.log('printReceiptWithNumber() called with receipt number:', receiptNumber);
        console.log('Current order length:', currentOrder.length);
        
        if (currentOrder.length === 0) {
            console.log('No items in current order, showing error');
            showNotification('No items to print!', 'error');
            return;
        }

        try {
            // Check if we have any connected printers (Bluetooth or WiFi)
            if (!isPrinterConnected()) {
                showNotification('No printers connected. Please connect a Bluetooth or WiFi printer.', 'warning');
                return;
            }

            // Generate receipt content with specific receipt number
            const receiptContent = await generateReceiptContent(receiptNumber);
            if (!receiptContent) {
                showNotification('Failed to generate receipt content', 'error');
                return;
            }
            
            // Check double printing setting
            const settings = JSON.parse(localStorage.getItem('pos-settings') || '{}');
            const doublePrint = settings.printer?.doublePrint || false;
            
            let results;
            if (doublePrint) {
                // Print twice for backup - first as Customer Copy, second as Company Copy
                const customerReceipt = await generateReceiptContent(receiptNumber, 'Customer Copy');
                const companyReceipt = await generateReceiptContent(receiptNumber, 'Company Copy');
                
                const firstPrint = await printToAllAvailablePrinters(customerReceipt);
                const secondPrint = await printToAllAvailablePrinters(companyReceipt);
                
                // Combine results
                results = firstPrint.map((result, index) => ({
                    ...result,
                    success: result.success && secondPrint[index]?.success
                }));
            } else {
                // Print once using unified printer system (Bluetooth + WiFi)
                results = await printToAllAvailablePrinters(receiptContent);
            }
            
            const successCount = results.filter(r => r.success).length;
            const failCount = results.filter(r => !r.success).length;
            
            if (successCount > 0) {
                const printMessage = doublePrint ? 
                    `Customer & Company copies printed to ${successCount} printer(s) successfully!` : 
                    `Receipt sent to ${successCount} printer(s) successfully!`;
                showNotification(printMessage, 'success');
            } else {
                showNotification('Failed to print receipt. Please check printer connections.', 'error');
            }

        } catch (error) {
            console.error('Print receipt error:', error);
            showNotification('Error printing receipt: ' + error.message, 'error');
        }
    }

    // Old generateReceiptContent function removed - now using database-driven version below

    // Universal Web Bluetooth support check
    function checkWebBluetoothSupport() {
        const isSupported = !!(navigator.bluetooth && typeof navigator.bluetooth.requestDevice === 'function');
        const browserName = getBrowserName();
        const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        let message = '';
        let type = 'info';
        
        if (isSupported) {
            message = `✅ Web Bluetooth is supported in ${browserName}! You can connect to Bluetooth printers directly from your browser.`;
            type = 'success';
        } else {
            message = `❌ Web Bluetooth is not supported in ${browserName}. Please use Chrome, Edge, Opera, or Opera Mini for Bluetooth printing.`;
            type = 'warning';
        }
        
        // Show detailed compatibility info
        const details = `
            <div class="mt-3">
                <h6>Universal Browser Compatibility:</h6>
                <ul class="list-unstyled small">
                    <li>• <strong>Chrome:</strong> ✅ Full support (Desktop & Mobile)</li>
                    <li>• <strong>Edge:</strong> ✅ Full support (Desktop & Mobile)</li>
                    <li>• <strong>Opera:</strong> ✅ Full support (Desktop & Mobile)</li>
                    <li>• <strong>Opera Mini:</strong> ✅ Full support (Mobile)</li>
                    <li>• <strong>Firefox:</strong> ❌ Not supported</li>
                    <li>• <strong>Safari:</strong> ❌ Limited support</li>
                </ul>
                <p class="small text-muted mt-2">
                    <strong>Note:</strong> Web Bluetooth requires HTTPS connection and user permission to access Bluetooth devices. 
                    ${isMobile ? 'On mobile devices, ensure location services are enabled for Bluetooth scanning.' : ''}
                </p>
            </div>
        `;
        
        showNotification(message + details, type);
    }
    
    function getBrowserName() {
        const userAgent = navigator.userAgent;
        if (userAgent.includes('Opera Mini')) return 'Opera Mini';
        if (userAgent.includes('Chrome') && !userAgent.includes('Edg')) return 'Chrome';
        if (userAgent.includes('Edg')) return 'Edge';
        if (userAgent.includes('Firefox')) return 'Firefox';
        if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) return 'Safari';
        if (userAgent.includes('Opera')) return 'Opera';
        return 'Unknown Browser';
    }
    
    


    // Universal Bluetooth scanning function - works on all compatible devices
    async function scanForBluetoothPrinters() {
        try {
            // Check if Web Bluetooth is supported
            if (!navigator.bluetooth || typeof navigator.bluetooth.requestDevice !== 'function') {
                showNotification('Web Bluetooth is not supported in this browser. Please use Chrome, Edge, Opera, or Opera Mini.', 'error');
                return false;
            }

            // Show Bluetooth scanning interface
            showBluetoothScanInterface();
            updateScanningStatus('Starting scan...', true);
            
            // Use enhanced manager if available
            const manager = window.enhancedBluetoothPrinterManager || window.bluetoothPrinterManager;
            
            if (!manager) {
                showNotification('Bluetooth manager not available. Please refresh the page.', 'error');
                updateScanningStatus('Error: Manager not available', false);
                return false;
            }

            // Universal device request
            const device = await navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: [
                    '000018f0-0000-1000-8000-00805f9b34fb', // BLE thermal printer
                    '00001800-0000-1000-8000-00805f9b34fb', // Generic Access
                    '00001801-0000-1000-8000-00805f9b34fb', // Generic Attribute
                    '00001101-0000-1000-8000-00805f9b34fb', // Serial Port Profile
                    '0000ffe0-0000-1000-8000-00805f9b34fb', // Custom service
                    '0000ffe1-0000-1000-8000-00805f9b34fb'  // Custom characteristic
                ]
            });

            // Check if device was selected (not cancelled)
            if (device) {
                updateScanningStatus('Connecting to device...', true);
                
                // Connect to the device
                const server = await device.gatt.connect();
                
                // Add printer to manager
                const printerId = await manager.addPrinter(device, server);
                
                // Show success and close modal
                showNotification(`Printer "${device.name || 'Unknown Device'}" connected successfully!`, 'success');
                updateScanningStatus('Connected successfully!', false);
                
                // Update UI
                updatePrinterSetupNotice();
                updatePrinterControlButtons();
                updateEmployeeValidationUI();
                
                // Close modal after successful connection
                setTimeout(() => {
                    hidePrinterSetupModal();
                    hideBluetoothScanInterface();
                }, 2000);
                
                return true;
            } else {
                // User cancelled the selection
                console.log('User cancelled Bluetooth device selection');
                updateScanningStatus('Scan cancelled', false);
                return false;
            }
            
        } catch (error) {
            console.error('Bluetooth scanning error:', error);
            
            // Universal error handling - treat user cancellation as normal
            if (error.name === 'NotFoundError') {
                // Check if it's user cancellation or no devices found
                if (error.message && error.message.includes('cancelled')) {
                    // User cancelled the dialog - this is normal, don't show error
                    console.log('User cancelled Bluetooth device selection');
                    updateScanningStatus('Scan cancelled', false);
                    return false;
                } else {
                    showNotification('No Bluetooth devices found. Make sure your printer is in pairing mode and nearby.', 'warning');
                    updateScanningStatus('No devices found', false);
                }
            } else if (error.name === 'SecurityError') {
                showNotification('Bluetooth access denied. Please allow Bluetooth permissions in your browser settings.', 'error');
                updateScanningStatus('Access denied', false);
            } else if (error.name === 'NotSupportedError') {
                showNotification('Bluetooth not supported on this device. Please use a compatible browser.', 'error');
                updateScanningStatus('Not supported', false);
            } else if (error.name === 'NetworkError') {
                showNotification('Connection failed. Make sure your printer is nearby and in pairing mode.', 'error');
                updateScanningStatus('Connection failed', false);
            } else {
                showNotification(`Bluetooth scanning error: ${error.message}`, 'error');
                updateScanningStatus('Error occurred', false);
            }
            
            return false;
        }
    }

    async function printViaWebBluetooth(printerId, content) {
        try {
            if (!window.bluetoothDevices || !window.bluetoothDevices.has(printerId)) {
                throw new Error('Bluetooth device not found. Please reconnect the printer.');
            }

            const { device, server } = window.bluetoothDevices.get(printerId);
            
            // Check if device is still connected
            if (!device.gatt.connected) {
                showNotification('Bluetooth device disconnected. Reconnecting...', 'warning');
                await device.gatt.connect();
            }

            // Try to find the BLE thermal printer service and characteristic
            let service, characteristic;
            
            try {
                // Try BLE thermal printer service first
                service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
                characteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');
            } catch (e) {
                try {
                    // Try Serial Port Profile
                service = await server.getPrimaryService('00001101-0000-1000-8000-00805f9b34fb');
                characteristic = await service.getCharacteristic('00001102-0000-1000-8000-00805f9b34fb');
                } catch (e2) {
                try {
                    // Try custom service
                    service = await server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');
                    characteristic = await service.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb');
                    } catch (e3) {
                    // Try to find any writable characteristic
                    const services = await server.getPrimaryServices();
                    for (const svc of services) {
                        try {
                            const characteristics = await svc.getCharacteristics();
                            for (const char of characteristics) {
                                if (char.properties.write || char.properties.writeWithoutResponse) {
                                    service = svc;
                                    characteristic = char;
                                    break;
                                }
                            }
                            if (characteristic) break;
                            } catch (e4) {
                            continue;
                            }
                        }
                    }
                }
            }

            if (!characteristic) {
                throw new Error('No writable characteristic found on this device');
            }

            // Convert content to bytes
            const encoder = new TextEncoder();
            const data = encoder.encode(content);

            // Send data in chunks (BLE characteristic max size is typically 20-244 bytes)
            const chunkSize = 244; // Use larger chunk size for better performance
            for (let i = 0; i < data.length; i += chunkSize) {
                const chunk = data.slice(i, i + chunkSize);
                await characteristic.writeValue(chunk);
                // Small delay between chunks to prevent overwhelming the printer
                if (i + chunkSize < data.length) {
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
            }

            showNotification('Print job sent via Bluetooth', 'success');
            return true;

        } catch (error) {
            console.error('Web Bluetooth print error:', error);
            showNotification(`Bluetooth print failed: ${error.message}`, 'error');
            return false;
        }
    }



    // Initialize event listeners
    function initializeEventListeners() {
        // Category filter buttons
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('category-filter')) {
                const category = e.target.getAttribute('data-category');
                filterByCategory(category);
            }
        });
        
        // Note: Add to order is now handled by onclick on the entire card
        
        // Cart item controls (add/remove from cart)
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('add-item') || e.target.closest('.add-item')) {
                const button = e.target.classList.contains('add-item') ? e.target : e.target.closest('.add-item');
                const itemId = parseInt(button.getAttribute('data-item-id'));
                addToOrder(itemId);
            }
            
            if (e.target.classList.contains('remove-item') || e.target.closest('.remove-item')) {
                const button = e.target.classList.contains('remove-item') ? e.target : e.target.closest('.remove-item');
                const itemId = parseInt(button.getAttribute('data-item-id'));
                removeFromOrder(itemId);
            }
        });
        
        // Clear cart button
        const clearCartBtn = document.getElementById('clearCartBtn');
        if (clearCartBtn) {
            clearCartBtn.addEventListener('click', function() {
                clearCart();
            });
        }
        
        // Process payment button removed
        
        // Print receipt button removed - auto-validation handles printing
        
        
        
        // Search functionality
        const searchInput = document.querySelector('input[placeholder="Search items..."]');
        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                searchItems(e.target.value);
            });
        }
        
        // Search button
        const searchButton = document.querySelector('button:has(.fa-search)');
        if (searchButton) {
            searchButton.addEventListener('click', function() {
                const searchInput = document.querySelector('input[placeholder="Search items..."]');
                if (searchInput) {
                    searchItems(searchInput.value);
                }
            });
        }
    }
</script>


<!-- Mobile Cart Popup -->
<div id="mobileCartPopup" class="fixed inset-0 z-50 bg-black bg-opacity-50 hidden md:hidden">
    <div class="flex items-end justify-center min-h-screen p-4">
        <div class="bg-white rounded-t-3xl w-full max-w-md max-h-[80vh] overflow-hidden transform transition-transform duration-300 translate-y-full" id="mobileCartContent">
            <!-- Cart Header -->
            <div class="bg-gradient-to-r from-primary-orange to-secondary-orange text-white p-4 flex items-center justify-between">
                <h3 class="text-lg font-bold flex items-center">
                    <i class="fas fa-shopping-cart mr-2"></i>
                    Current Order
                </h3>
                <button id="closeMobileCart" class="text-white hover:text-gray-200 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                            </button>
                            </div>
            
            <!-- Cart Content - Copy of existing cart -->
            <div class="p-4 max-h-96 overflow-y-auto">
                <!-- Order Items -->
                <div id="mobileOrderItems" class="space-y-3 mb-4">
                    <!-- Empty cart state -->
                    <div id="mobileEmptyCart" class="text-center py-12">
                        <div class="w-20 h-20 bg-gradient-to-br from-gray-100 to-gray-200 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-lg">
                            <i class="fas fa-shopping-cart text-gray-400 text-3xl"></i>
                            </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-3">Your cart is empty</h3>
                        <p class="text-gray-600">Add items from the menu to get started</p>
                            </div>
                            </div>

                <!-- Order Summary -->
                <div id="mobileOrderSummary" class="border-t border-gray-200 pt-4 space-y-2 hidden">
                    <div class="flex justify-between text-gray-600 text-sm">
                        <span>Subtotal:</span>
                        <span id="mobileSubtotal">KSh 0.00</span>
                        </div>
                    <div id="mobileTaxLine" class="flex justify-between text-gray-600 text-sm">
                        <span>Tax (8%):</span>
                        <span id="mobileTax">KSh 0.00</span>
                    </div>
                    <div class="flex justify-between text-base font-bold text-gray-800 border-t border-gray-200 pt-2">
                        <span>Total:</span>
                        <span id="mobileTotal">KSh 0.00</span>
                </div>
                </div>

                <!-- Employee Validation Section -->
                <div id="mobileEmployeeValidation" class="mt-4 hidden">
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-base font-semibold text-blue-800 flex items-center">
                                <i class="fas fa-user-check mr-2"></i>
                                Employee Code
                            </h4>
                            <div id="mobileEmployeeValidationStatus" class="w-3 h-3 bg-gray-400 rounded-full"></div>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">4-digit Code</label>
                                <input type="text" id="mobileReceiptEmployeeCode" maxlength="4" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center text-base font-mono tracking-widest"
                                       placeholder="0000" required>
                                <div id="mobileEmployeeValidationMessage" class="mt-2 text-sm"></div>
                            </div>
                            <div id="mobileEmployeeInfo" class="hidden bg-white rounded-lg p-3 border border-blue-200">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-user text-blue-600 text-sm"></i>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-gray-800 text-sm" id="mobileEmployeeName">Employee Name</div>
                                        <div class="text-xs text-gray-600" id="mobileEmployeeCode">Code: 0000</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons Removed - Auto-validation handles printing -->
            </div>
        </div>
    </div>
</div>

<script>
    // Mobile cart functionality
    function initializeMobileCart() {
        const mobileCartBtn = document.getElementById('mobileCartButton');
        const mobileCartPopup = document.getElementById('mobileCartPopup');
        const closeMobileCart = document.getElementById('closeMobileCartBtn');
        const mobileCartContent = document.getElementById('mobileCartContent');
        const cartCountBadge = document.getElementById('cartCountBadge');
        const cartCount = document.getElementById('cartCount');
        const cartPulse = document.getElementById('cartPulse');
        
        // Store references globally for use in updateMobileCartBadge
        window.mobileCartBtn = mobileCartBtn;

        // Open mobile cart
        if (mobileCartBtn) {
            console.log('Mobile cart button found, adding click listener');
            mobileCartBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('Mobile cart button clicked, currentOrder length:', currentOrder.length);
                if (window.syncMobileCartWithDesktop) {
                    console.log('Syncing mobile cart before opening...');
                    window.syncMobileCartWithDesktop();
                }
                if (mobileCartPopup) {
                    mobileCartPopup.classList.remove('hidden');
                }
                setTimeout(() => {
                    if (mobileCartContent) {
                        mobileCartContent.classList.remove('translate-y-full');
                    }
                }, 10);
            });
        } else {
            console.error('Mobile cart button not found!');
        }

        // Close mobile cart (moved to global scope)
        window.closeMobileCartPopup = function() {
            console.log('Closing mobile cart popup...');
            if (mobileCartContent) {
                mobileCartContent.classList.add('translate-y-full');
            }
            setTimeout(() => {
                if (mobileCartPopup) {
                    mobileCartPopup.classList.add('hidden');
                    console.log('Mobile cart popup closed');
                }
            }, 300);
        };

        if (closeMobileCart) {
            console.log('Close mobile cart button found, adding event listener');
            closeMobileCart.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Close mobile cart button clicked');
                if (window.closeMobileCartPopup) {
                    window.closeMobileCartPopup();
                } else {
                    console.error('closeMobileCartPopup function not found!');
                }
            });
            
            // Also add mousedown event as backup
            closeMobileCart.addEventListener('mousedown', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Close mobile cart button mousedown');
                if (window.closeMobileCartPopup) {
                    window.closeMobileCartPopup();
                }
            });
        } else {
            console.error('Close mobile cart button not found!');
        }

        // Close on backdrop click
        if (mobileCartPopup) {
            mobileCartPopup.addEventListener('click', (e) => {
                if (e.target === mobileCartPopup) {
                    window.closeMobileCartPopup();
                }
            });
        }
        
        // Add global event delegation for close button as ultimate fallback
        document.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'closeMobileCartBtn') {
                e.preventDefault();
                e.stopPropagation();
                console.log('Global close mobile cart button clicked');
                if (window.closeMobileCartPopup) {
                    window.closeMobileCartPopup();
                } else {
                    console.error('closeMobileCartPopup function not found in global handler!');
                }
            }
        });

        // Mobile cart action buttons removed - auto-validation handles printing

        // Update mobile cart display
        window.updateMobileCart = function() {
            console.log('updateMobileCart called, currentOrder length:', currentOrder.length);
            updateMobileCartBadge();
            if (window.syncMobileCartWithDesktop) {
                console.log('Syncing mobile cart with desktop...');
                window.syncMobileCartWithDesktop();
            }
        };

        // Update only the floating cart badge
        function updateMobileCartBadge() {
            const totalItems = currentOrder.reduce((sum, item) => sum + item.quantity, 0);
            console.log('Updating mobile cart badge, total items:', totalItems);
            
            // Update cart count badge
            if (totalItems > 0) {
                if (cartCountBadge) {
                    cartCountBadge.classList.remove('hidden');
                }
                if (cartCount) {
                    cartCount.textContent = totalItems;
                }
                
                // Show pulse animation
                if (cartPulse) {
                    cartPulse.classList.remove('hidden');
                    setTimeout(() => {
                        if (cartPulse) {
                            cartPulse.classList.add('hidden');
                        }
                    }, 1000);
                }
                
                // Add active state to button
                if (window.mobileCartBtn) {
                    window.mobileCartBtn.classList.add('cart-has-items');
                }
            } else {
                if (cartCountBadge) {
                    cartCountBadge.classList.add('hidden');
                }
                
                // Remove active state from button
                if (window.mobileCartBtn) {
                    window.mobileCartBtn.classList.remove('cart-has-items');
                }
            }
        }

        // Make updateMobileCartBadge globally accessible
        window.updateMobileCartBadge = updateMobileCartBadge;
        
        // Initialize cart badge on load
        setTimeout(() => {
            updateMobileCartBadge();
        }, 500);

        // Sync mobile cart with desktop cart (copy the exact same content)
        window.syncMobileCartWithDesktop = function() {
            console.log('syncMobileCartWithDesktop called, currentOrder length:', currentOrder.length);
            console.log('currentOrder items:', currentOrder.map(item => ({id: item.id, name: item.name, quantity: item.quantity})));
            const mobileOrderItems = document.getElementById('mobileOrderItems');
            const mobileEmptyCart = document.getElementById('mobileEmptyCart');
            const mobileOrderSummary = document.getElementById('mobileOrderSummary');
            const mobileEmployeeValidation = document.getElementById('mobileEmployeeValidation');

            // Check if all required elements exist
            if (!mobileOrderItems || !mobileEmptyCart || !mobileOrderSummary || !mobileEmployeeValidation) {
                console.error('Mobile cart elements not found:', {
                    mobileOrderItems: !!mobileOrderItems,
                    mobileEmptyCart: !!mobileEmptyCart,
                    mobileOrderSummary: !!mobileOrderSummary,
                    mobileEmployeeValidation: !!mobileEmployeeValidation
                });
                return;
            }

            if (currentOrder.length === 0) {
                console.log('Showing mobile empty cart state');
                // Show empty state
                mobileEmptyCart.classList.remove('hidden');
                mobileOrderSummary.classList.add('hidden');
                mobileEmployeeValidation.classList.add('hidden');
                mobileOrderItems.innerHTML = '';
                mobileOrderItems.appendChild(mobileEmptyCart);
            } else {
                // Hide empty state
                mobileEmptyCart.classList.add('hidden');
                mobileOrderSummary.classList.remove('hidden');
                mobileEmployeeValidation.classList.remove('hidden');
                
                // Generate mobile cart HTML directly from currentOrder instead of cloning desktop cart
                console.log('Generating mobile cart HTML for', currentOrder.length, 'items');
                const mobileOrderItemsHTML = currentOrder.map(item => `
                    <div class="flex items-center justify-between p-2 sm:p-3 bg-gray-50 rounded-lg" data-item-id="${item.id}">
                        <div class="flex-1 min-w-0 mr-2">
                            <h4 class="font-medium text-gray-800 text-xs sm:text-sm lg:text-base truncate">${item.name}</h4>
                            <p class="text-xs sm:text-sm text-gray-600">KSh ${item.price.toFixed(2)} each</p>
                        </div>
                        <div class="flex items-center space-x-1 sm:space-x-2">
                            <button class="remove-item w-6 h-6 sm:w-7 sm:h-7 lg:w-8 lg:h-8 bg-gray-200 rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors duration-200 touch-target" data-item-id="${item.id}">
                                <i class="fas fa-minus text-xs sm:text-sm"></i>
                            </button>
                            <span class="w-6 sm:w-7 lg:w-8 text-center font-medium text-xs sm:text-sm lg:text-base">${item.quantity}</span>
                            <button class="add-item w-6 h-6 sm:w-7 sm:h-7 lg:w-8 lg:h-8 bg-primary-orange text-white rounded-full flex items-center justify-center hover:bg-secondary-orange transition-colors duration-200 touch-target" data-item-id="${item.id}">
                                <i class="fas fa-plus text-xs sm:text-sm"></i>
                            </button>
                        </div>
                        <div class="ml-1 sm:ml-2 lg:ml-4">
                            <span class="font-semibold text-gray-800 text-xs sm:text-sm lg:text-base">KSh ${(item.price * item.quantity).toFixed(2)}</span>
                        </div>
                    </div>
                `).join('');
                
                mobileOrderItems.innerHTML = mobileOrderItemsHTML;
                console.log('Mobile cart HTML generated and inserted, items count:', currentOrder.length);
                console.log('Mobile cart HTML length:', mobileOrderItemsHTML.length);
                console.log('Mobile cart children count after insert:', mobileOrderItems.children.length);
                
                // Re-attach event listeners for quantity buttons in mobile cart
                attachMobileCartEventListeners();
                
                // Copy order summary values
                const desktopSubtotal = document.getElementById('subtotal');
                const desktopTax = document.getElementById('tax');
                const desktopTotal = document.getElementById('total');
                const desktopTaxLine = document.getElementById('taxLine');
                
                if (desktopSubtotal) document.getElementById('mobileSubtotal').textContent = desktopSubtotal.textContent;
                if (desktopTax) document.getElementById('mobileTax').textContent = desktopTax.textContent;
                if (desktopTotal) document.getElementById('mobileTotal').textContent = desktopTotal.textContent;
                
                // Show/hide tax line based on desktop
                const mobileTaxLine = document.getElementById('mobileTaxLine');
                if (mobileTaxLine && desktopTaxLine) {
                    if (desktopTaxLine.classList.contains('hidden')) {
                        mobileTaxLine.classList.add('hidden');
            } else {
                        mobileTaxLine.classList.remove('hidden');
                    }
                }
            }
        };
        
        // Attach event listeners for mobile cart quantity buttons
        function attachMobileCartEventListeners() {
            console.log('Attaching mobile cart event listeners...');
            
            // Add event listeners for quantity buttons in mobile cart
            const mobileOrderItems = document.getElementById('mobileOrderItems');
            if (mobileOrderItems) {
                // Remove any existing listeners to avoid duplicates
                mobileOrderItems.removeEventListener('click', handleMobileCartClick);
                
                // Add new event listener
                mobileOrderItems.addEventListener('click', handleMobileCartClick);
            }
        }
        
        // Handle clicks on mobile cart quantity buttons
        function handleMobileCartClick(e) {
            console.log('Mobile cart click detected:', e.target);
            
            // Handle add item button
            if (e.target.classList.contains('add-item') || e.target.closest('.add-item')) {
                e.preventDefault();
                e.stopPropagation();
                const button = e.target.classList.contains('add-item') ? e.target : e.target.closest('.add-item');
                const itemId = parseInt(button.getAttribute('data-item-id'));
                console.log('Adding item to cart from mobile:', itemId);
                addToOrder(itemId);
                
                // Force immediate mobile cart update since user is interacting with mobile cart
                setTimeout(() => {
                    if (window.syncMobileCartWithDesktop) {
                        console.log('Force syncing mobile cart after mobile interaction');
                        window.syncMobileCartWithDesktop();
                    }
                }, 50);
                return;
            }
            
            // Handle remove item button
            if (e.target.classList.contains('remove-item') || e.target.closest('.remove-item')) {
                e.preventDefault();
                e.stopPropagation();
                const button = e.target.classList.contains('remove-item') ? e.target : e.target.closest('.remove-item');
                const itemId = parseInt(button.getAttribute('data-item-id'));
                console.log('Removing item from cart from mobile:', itemId);
                removeFromOrder(itemId);
                
                // Force immediate mobile cart update since user is interacting with mobile cart
                setTimeout(() => {
                    if (window.syncMobileCartWithDesktop) {
                        console.log('Force syncing mobile cart after mobile interaction');
                        window.syncMobileCartWithDesktop();
                    }
                }, 50);
                return;
            }
        }
    }

    // Initialize mobile cart when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing mobile cart...');
        initializeMobileCart();
        
        // Fallback initialization after a short delay
        setTimeout(() => {
            const mobileCartBtn = document.getElementById('mobileCartButton');
            if (mobileCartBtn && !mobileCartBtn.hasAttribute('data-listener-added')) {
                console.log('Adding fallback mobile cart click listener');
                mobileCartBtn.setAttribute('data-listener-added', 'true');
                mobileCartBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Fallback mobile cart button clicked');
                    const mobileCartPopup = document.getElementById('mobileCartPopup');
                    const mobileCartContent = document.getElementById('mobileCartContent');
                    if (window.syncMobileCartWithDesktop) {
                        window.syncMobileCartWithDesktop();
                    }
                    if (mobileCartPopup) {
                        mobileCartPopup.classList.remove('hidden');
                    }
                    setTimeout(() => {
                        if (mobileCartContent) {
                            mobileCartContent.classList.remove('translate-y-full');
                        }
                    }, 10);
                });
            }
            
            // Fallback for close button
            const closeMobileCart = document.getElementById('closeMobileCartBtn');
            if (closeMobileCart && !closeMobileCart.hasAttribute('data-listener-added')) {
                console.log('Adding fallback close mobile cart click listener');
                closeMobileCart.setAttribute('data-listener-added', 'true');
                closeMobileCart.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Fallback close mobile cart button clicked');
                    if (window.closeMobileCartPopup) {
                        window.closeMobileCartPopup();
                    } else {
                        console.error('closeMobileCartPopup function not found in fallback!');
                    }
                });
                
                // Also add mousedown as backup
                closeMobileCart.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Fallback close mobile cart button mousedown');
                    if (window.closeMobileCartPopup) {
                        window.closeMobileCartPopup();
                    }
                });
            }
        }, 1000);
    });

    // Receipt Number System (Database-driven)
    let currentEmployee = null;

    // Get next receipt number from database
    async function getNextReceiptNumber() {
        try {
            const response = await fetch('/api/receipt/next-number');
            const result = await response.json();
            
            if (result.success) {
                return result.receipt_number;
            } else {
                throw new Error(result.message || 'Failed to get receipt number');
            }
        } catch (error) {
            console.error('Error getting receipt number:', error);
            throw error;
        }
    }

    // Check if printer is connected (Bluetooth or WiFi)
    function isPrinterConnected() {
        // Check unified manager first (preferred method)
        if (window.unifiedPrinterManager) {
            const printers = window.unifiedPrinterManager.getAllConnectedPrinters();
            return printers.all.length > 0;
        }
        
        // Fallback: Check individual managers
        let bluetoothConnected = false;
        let wifiConnected = false;
        
        // Check Bluetooth printers
        if (window.bluetoothPrinterManager) {
            try {
                const bluetoothPrinters = window.bluetoothPrinterManager.getConnectedPrinters();
                bluetoothConnected = bluetoothPrinters.length > 0;
            } catch (e) {
                console.warn('Error checking Bluetooth printer status:', e);
            }
        }
        
        // Check WiFi printers
        if (window.wifiPrinterManager) {
            try {
                const wifiPrinters = window.wifiPrinterManager.getConnectedPrinters();
                wifiConnected = wifiPrinters.length > 0;
            } catch (e) {
                console.warn('Error checking WiFi printer status:', e);
            }
        }
        
        return bluetoothConnected || wifiConnected;
    }

    // Print to all available printers (unified manager or fallback)
    async function printToAllAvailablePrinters(content) {
        console.log('=== RECEIPT PRINTING DEBUG ===');
        console.log('Content length:', content ? content.length : 'null');
        console.log('Content preview:', content ? content.substring(0, 100) + '...' : 'null');
        
        // Check if we're in a hosted environment
        const isHosted = window.location.hostname.includes('mmuchafua.co.ke') || 
                        window.location.hostname.includes('github.io') || 
                        window.location.hostname.includes('netlify.app') ||
                        window.location.hostname.includes('vercel.app') ||
                        window.location.hostname.includes('herokuapp.com') ||
                        window.location.hostname.includes('railway.app') ||
                        window.location.hostname.includes('render.com') ||
                        window.location.hostname.includes('fly.dev') ||
                        window.location.hostname.includes('aws.amazon.com') ||
                        window.location.hostname.includes('azure.com') ||
                        window.location.hostname.includes('digitalocean.com') ||
                        (window.location.hostname !== 'localhost' && 
                         window.location.hostname !== '127.0.0.1' &&
                         !window.location.hostname.match(/^\d+\.\d+\.\d+\.\d+$/));
        
        console.log('Is hosted environment:', isHosted);
        
        if (isHosted) {
            console.log('Hosted environment detected - using enhanced client-side printing approach');
            // For hosted environments, try enhanced client-side printing with Bluetooth fallback
            return await performEnhancedClientSidePrint(content);
        }
        
        // Try unified manager first (preferred method) - same as test function
        if (window.unifiedPrinterManager && window.unifiedPrinterManager.printToAllPrinters) {
            try {
                console.log('Using unified printer manager for receipt printing...');
                const results = await window.unifiedPrinterManager.printToAllPrinters(content);
                console.log('Unified printer manager results:', results);
                return results;
            } catch (error) {
                console.warn('Unified printer manager failed, trying fallback:', error);
            }
        }
        
        // Fallback: Print to individual managers (same as test function)
        const results = [];
        
        // Print to Bluetooth printers
        if (window.bluetoothPrinterManager) {
            try {
                console.log('Trying Bluetooth printer manager...');
                const bluetoothResult = await window.bluetoothPrinterManager.printToAllPrinters(content);
                results.push(...bluetoothResult);
                console.log('Bluetooth printing results:', bluetoothResult);
            } catch (error) {
                console.warn('Bluetooth printing failed:', error);
                results.push({ printerId: 'bluetooth', success: false, error: error.message });
            }
        }
        
        // Print to WiFi printers
        if (window.wifiPrinterManager) {
            try {
                console.log('Trying WiFi printer manager...');
                const wifiResult = await window.wifiPrinterManager.printToAllPrinters(content);
                results.push(...wifiResult);
                console.log('WiFi printing results:', wifiResult);
            } catch (error) {
                console.warn('WiFi printing failed:', error);
                results.push({ printerId: 'wifi', success: false, error: error.message });
            }
        }
        
        // If we have results, return them
        if (results.length > 0) {
            return results;
        }
        
        // Original fallback code (keeping for compatibility)
        if (window.bluetoothPrinterManager) {
            try {
                const bluetoothResult = await window.bluetoothPrinterManager.printToAllPrinters(content);
                results.push(...bluetoothResult);
            } catch (error) {
                console.warn('Bluetooth printing failed:', error);
                results.push({ printerId: 'bluetooth', success: false, error: error.message });
            }
        }
        
        // Print to WiFi printers
        if (window.wifiPrinterManager) {
            try {
                const wifiResult = await window.wifiPrinterManager.printToAllPrinters(content);
                results.push(...wifiResult);
            } catch (error) {
                console.warn('WiFi printing failed:', error);
                results.push({ printerId: 'wifi', success: false, error: error.message });
            }
        }
        
        // If no results, return a failure result
        if (results.length === 0) {
            results.push({ printerId: 'none', success: false, error: 'No printers available' });
        }
        
        return results;
    }

    // Update employee validation UI based on printer connection
    function updateEmployeeValidationUI() {
        const receiptEmployeeCode = document.getElementById('receiptEmployeeCode');
        const mobileReceiptEmployeeCode = document.getElementById('mobileReceiptEmployeeCode');
        const employeeValidationMessage = document.getElementById('employeeValidationMessage');
        const mobileEmployeeValidationMessage = document.getElementById('mobileEmployeeValidationMessage');
        
        const printerConnected = isPrinterConnected();
        console.log('Updating employee validation UI. Printer connected:', printerConnected);
        
        // Debug information
        if (!printerConnected) {
            console.log('Debug - Checking printer managers:');
            console.log('- Unified manager available:', !!window.unifiedPrinterManager);
            console.log('- Bluetooth manager available:', !!window.bluetoothPrinterManager);
            console.log('- WiFi manager available:', !!window.wifiPrinterManager);
            
            if (window.wifiPrinterManager) {
                try {
                    const wifiPrinters = window.wifiPrinterManager.getConnectedPrinters();
                    console.log('- WiFi printers connected:', wifiPrinters.length, wifiPrinters);
                } catch (e) {
                    console.log('- WiFi printer check error:', e);
                }
            }
            
            if (window.bluetoothPrinterManager) {
                try {
                    const bluetoothPrinters = window.bluetoothPrinterManager.getConnectedPrinters();
                    console.log('- Bluetooth printers connected:', bluetoothPrinters.length);
                } catch (e) {
                    console.log('- Bluetooth printer check error:', e);
                }
            }
        }
        
        if (printerConnected) {
            // Enable inputs and clear warning messages
            if (receiptEmployeeCode) {
                receiptEmployeeCode.disabled = false;
                receiptEmployeeCode.placeholder = "0000";
                receiptEmployeeCode.classList.remove('bg-gray-100', 'text-gray-400');
                receiptEmployeeCode.classList.add('bg-white', 'text-gray-900');
            }
            if (mobileReceiptEmployeeCode) {
                mobileReceiptEmployeeCode.disabled = false;
                mobileReceiptEmployeeCode.placeholder = "0000";
                mobileReceiptEmployeeCode.classList.remove('bg-gray-100', 'text-gray-400');
                mobileReceiptEmployeeCode.classList.add('bg-white', 'text-gray-900');
            }
            if (employeeValidationMessage) {
                employeeValidationMessage.textContent = '';
                employeeValidationMessage.className = 'mt-2 text-sm';
            }
            if (mobileEmployeeValidationMessage) {
                mobileEmployeeValidationMessage.textContent = '';
                mobileEmployeeValidationMessage.className = 'mt-2 text-sm';
            }
                } else {
            // Disable inputs and show warning
            if (receiptEmployeeCode) {
                receiptEmployeeCode.disabled = true;
                receiptEmployeeCode.placeholder = "Connect printer first";
                receiptEmployeeCode.value = '';
                receiptEmployeeCode.classList.add('bg-gray-100', 'text-gray-400');
                receiptEmployeeCode.classList.remove('bg-white', 'text-gray-900');
            }
            if (mobileReceiptEmployeeCode) {
                mobileReceiptEmployeeCode.disabled = true;
                mobileReceiptEmployeeCode.placeholder = "Connect printer first";
                mobileReceiptEmployeeCode.value = '';
                mobileReceiptEmployeeCode.classList.add('bg-gray-100', 'text-gray-400');
                mobileReceiptEmployeeCode.classList.remove('bg-white', 'text-gray-900');
            }
            if (employeeValidationMessage) {
                employeeValidationMessage.textContent = '⚠️ Please connect a printer first (Bluetooth or WiFi)';
                employeeValidationMessage.className = 'mt-2 text-sm text-amber-600';
            }
            if (mobileEmployeeValidationMessage) {
                mobileEmployeeValidationMessage.textContent = '⚠️ Please connect a printer first (Bluetooth or WiFi)';
                mobileEmployeeValidationMessage.className = 'mt-2 text-sm text-amber-600';
            }
        }
    }

    // Employee validation functions
    function initializeEmployeeValidation() {
        const receiptEmployeeCode = document.getElementById('receiptEmployeeCode');
        const validateEmployeeBtn = document.getElementById('validateEmployeeBtn');
        const employeeValidationMessage = document.getElementById('employeeValidationMessage');
        const employeeValidationStatus = document.getElementById('employeeValidationStatus');
        const employeeInfo = document.getElementById('employeeInfo');

        // Mobile elements
        const mobileReceiptEmployeeCode = document.getElementById('mobileReceiptEmployeeCode');
        const mobileEmployeeValidationMessage = document.getElementById('mobileEmployeeValidationMessage');
        const mobileEmployeeValidationStatus = document.getElementById('mobileEmployeeValidationStatus');
        const mobileEmployeeInfo = document.getElementById('mobileEmployeeInfo');

        // Input validation for desktop - auto-validate on 4th digit
        if (receiptEmployeeCode) {
            receiptEmployeeCode.addEventListener('input', function(e) {
                // Check if printer is connected first
                if (!isPrinterConnected()) {
                    this.value = '';
                    updateEmployeeValidationUI();
                    return;
                }
                
                this.value = this.value.replace(/[^0-9]/g, '');
                
                // Auto-validate when 4 digits are entered
                if (this.value.length === 4) {
                    console.log('4-digit code entered, calling validateEmployeeAndPrint()');
                    validateEmployeeAndPrint();
            } else {
                    // Reset validation state
                    employeeValidationStatus.className = 'w-3 h-3 bg-gray-400 rounded-full';
                    employeeInfo.classList.add('hidden');
                    employeeValidationMessage.textContent = '';
                }
            });

            receiptEmployeeCode.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && this.value.length === 4) {
                    validateEmployeeAndPrint();
                }
            });
        }

        // Input validation for mobile - auto-validate on 4th digit
        if (mobileReceiptEmployeeCode) {
            mobileReceiptEmployeeCode.addEventListener('input', function(e) {
                // Check if printer is connected first
                if (!isPrinterConnected()) {
                    this.value = '';
                    updateEmployeeValidationUI();
                    return;
                }
                
                this.value = this.value.replace(/[^0-9]/g, '');
                
                // Auto-validate when 4 digits are entered
                if (this.value.length === 4) {
                    validateEmployeeAndPrintMobile();
                } else {
                    // Reset validation state
                    mobileEmployeeValidationStatus.className = 'w-3 h-3 bg-gray-400 rounded-full';
                    mobileEmployeeInfo.classList.add('hidden');
                    mobileEmployeeValidationMessage.textContent = '';
                }
            });

            mobileReceiptEmployeeCode.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && this.value.length === 4) {
                    validateEmployeeAndPrintMobile();
                }
            });
        }

        // Auto-validate and print for desktop
        async function validateEmployeeAndPrint() {
            console.log('validateEmployeeAndPrint() called');
            
            // Check if printer is connected first
            if (!isPrinterConnected()) {
                console.log('No printer connected, showing error');
                showValidationMessage('⚠️ Please connect a printer first (Bluetooth or WiFi)', 'error');
                updateEmployeeValidationUI();
                return;
            }
            
            console.log('Printer is connected, proceeding with validation');
            
            const employeeCode = receiptEmployeeCode.value;
            
            // Show loading state
            employeeValidationStatus.className = 'w-3 h-3 bg-yellow-400 rounded-full animate-pulse';
            showValidationMessage('Validating...', 'info');
            receiptEmployeeCode.disabled = true;

            try {
                const response = await fetch('/employee/validate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ employee_code: employeeCode })
                });
                
                const data = await response.json();

                if (data.success) {
                    currentEmployee = data.employee;
                    showValidationMessage(`✓ Valid! Printing receipt...`, 'success');
                    employeeValidationStatus.className = 'w-3 h-3 bg-green-400 rounded-full animate-pulse';
                    employeeInfo.classList.remove('hidden');
                    document.getElementById('employeeName').textContent = data.employee.name;
                    document.getElementById('employeeCode').textContent = `Code: ${data.employee.employee_code}`;
                    
                    // Save sale data and print receipt
                    setTimeout(async () => {
                        try {
                            // Save sale data to database first
                            showValidationMessage(`✓ Saving sale data...`, 'success');
                            const saleResult = await saveSaleToDatabase();
                            
                            // Then print receipt with the same receipt number
                            showValidationMessage(`✓ Printing receipt...`, 'success');
                            console.log('Calling printReceiptWithNumber with receipt number:', saleResult.receipt_number);
                            await printReceiptWithNumber(saleResult.receipt_number);
                            console.log('Print completed successfully');
                            showValidationMessage(`✓ Receipt printed successfully!`, 'success');
                            
                            // Clear cart and reset after successful print
                            setTimeout(() => {
                                // Clear the cart
                                currentOrder = [];
                                updateOrderDisplay();
                                updateMobileCart();
                                
                                // Force cart badge update
                                if (window.updateMobileCartBadge) {
                                    window.updateMobileCartBadge();
                                }
                                
                                // Reload menu items to reflect updated stock
                                loadMenuItems();
                                
                                // Reset employee validation
                                receiptEmployeeCode.value = '';
                                receiptEmployeeCode.disabled = false;
                                receiptEmployeeCode.focus();
                                employeeValidationStatus.className = 'w-3 h-3 bg-gray-400 rounded-full';
                                employeeInfo.classList.add('hidden');
                                showValidationMessage('', '');
                                
                                // Reset current employee
                                currentEmployee = null;
                            }, 2000);
                        } catch (error) {
                            console.error('Save/Print error:', error);
                            showValidationMessage(`✗ ${error.message}. Try again.`, 'error');
                            receiptEmployeeCode.disabled = false;
                        }
                    }, 1000);
                } else {
                    showValidationMessage('✗ Invalid code. Try again.', 'error');
                    employeeValidationStatus.className = 'w-3 h-3 bg-red-400 rounded-full';
                    employeeInfo.classList.add('hidden');
                    
                    // Clear input and allow retry
                    setTimeout(() => {
                        receiptEmployeeCode.value = '';
                        receiptEmployeeCode.disabled = false;
                        receiptEmployeeCode.focus();
                        employeeValidationStatus.className = 'w-3 h-3 bg-gray-400 rounded-full';
                        showValidationMessage('', '');
                    }, 2000);
            }
        } catch (error) {
                console.error('Error validating employee:', error);
                showValidationMessage('✗ Connection error. Try again.', 'error');
                employeeValidationStatus.className = 'w-3 h-3 bg-red-400 rounded-full';
                
                setTimeout(() => {
                    receiptEmployeeCode.value = '';
                    receiptEmployeeCode.disabled = false;
                    receiptEmployeeCode.focus();
                    employeeValidationStatus.className = 'w-3 h-3 bg-gray-400 rounded-full';
                    showValidationMessage('', '');
                }, 2000);
            }
        }

        // Auto-validate and print for mobile
        async function validateEmployeeAndPrintMobile() {
            // Check if printer is connected first
            if (!isPrinterConnected()) {
                showMobileValidationMessage('⚠️ Please connect a printer first (Bluetooth or WiFi)', 'error');
                updateEmployeeValidationUI();
                return;
            }
            
            const employeeCode = mobileReceiptEmployeeCode.value;
            
            // Show loading state
            mobileEmployeeValidationStatus.className = 'w-3 h-3 bg-yellow-400 rounded-full animate-pulse';
            showMobileValidationMessage('Validating...', 'info');
            mobileReceiptEmployeeCode.disabled = true;

            try {
                const response = await fetch('/employee/validate', {
            method: 'POST',
            headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ employee_code: employeeCode })
                });

                const data = await response.json();

            if (data.success) {
                    currentEmployee = data.employee;
                    showMobileValidationMessage(`✓ Valid! Printing receipt...`, 'success');
                    mobileEmployeeValidationStatus.className = 'w-3 h-3 bg-green-400 rounded-full animate-pulse';
                    mobileEmployeeInfo.classList.remove('hidden');
                    document.getElementById('mobileEmployeeName').textContent = data.employee.name;
                    document.getElementById('mobileEmployeeCode').textContent = `Code: ${data.employee.employee_code}`;
                    
                    // Save sale data and print receipt
                    setTimeout(async () => {
                        try {
                            // Save sale data to database first
                            showMobileValidationMessage(`✓ Saving sale data...`, 'success');
                            const saleResult = await saveSaleToDatabase();
                            
                            // Then print receipt with the same receipt number
                            showMobileValidationMessage(`✓ Printing receipt...`, 'success');
                            await printReceiptWithNumber(saleResult.receipt_number);
                            showMobileValidationMessage(`✓ Receipt printed!`, 'success');
                            
                            // Clear cart, close mobile popup and reset after successful print
                            setTimeout(() => {
                                console.log('Starting mobile cart clear process...');
                                
                                // Clear the cart
                                currentOrder = [];
                                console.log('Cart cleared, currentOrder length:', currentOrder.length);
                                
                                updateOrderDisplay();
                                updateMobileCart();
                                
                                // Force cart badge update
                                if (window.updateMobileCartBadge) {
                                    window.updateMobileCartBadge();
                                }
                                
                                // Reload menu items to reflect updated stock
                                loadMenuItems();
                                
                                // Close mobile cart popup
                                if (window.closeMobileCartPopup) {
                                    console.log('Calling closeMobileCartPopup...');
                                    window.closeMobileCartPopup();
            } else {
                                    console.error('closeMobileCartPopup function not found!');
                                }
                                
                                // Reset employee validation
                                mobileReceiptEmployeeCode.value = '';
                                mobileReceiptEmployeeCode.disabled = false;
                                mobileEmployeeValidationStatus.className = 'w-3 h-3 bg-gray-400 rounded-full';
                                mobileEmployeeInfo.classList.add('hidden');
                                showMobileValidationMessage('', '');
                                
                                // Reset current employee
                                currentEmployee = null;
                                
                                console.log('Mobile cart clear process completed');
                            }, 2000);
                        } catch (error) {
                            console.error('Save/Print error:', error);
                            showMobileValidationMessage(`✗ ${error.message}. Try again.`, 'error');
                            mobileReceiptEmployeeCode.disabled = false;
                        }
                    }, 1000);
            } else {
                    showMobileValidationMessage('✗ Invalid code. Try again.', 'error');
                    mobileEmployeeValidationStatus.className = 'w-3 h-3 bg-red-400 rounded-full';
                    mobileEmployeeInfo.classList.add('hidden');
                    
                    // Clear input and allow retry
                    setTimeout(() => {
                        mobileReceiptEmployeeCode.value = '';
                        mobileReceiptEmployeeCode.disabled = false;
                        mobileReceiptEmployeeCode.focus();
                        mobileEmployeeValidationStatus.className = 'w-3 h-3 bg-gray-400 rounded-full';
                        showMobileValidationMessage('', '');
                    }, 2000);
                }
            } catch (error) {
                console.error('Error validating employee:', error);
                showMobileValidationMessage('✗ Connection error. Try again.', 'error');
                mobileEmployeeValidationStatus.className = 'w-3 h-3 bg-red-400 rounded-full';
                
                setTimeout(() => {
                    mobileReceiptEmployeeCode.value = '';
                    mobileReceiptEmployeeCode.disabled = false;
                    mobileReceiptEmployeeCode.focus();
                    mobileEmployeeValidationStatus.className = 'w-3 h-3 bg-gray-400 rounded-full';
                    showMobileValidationMessage('', '');
                }, 2000);
            }
        }

        // Show validation message for desktop
        function showValidationMessage(message, type) {
            employeeValidationMessage.textContent = message;
            if (type === 'success') {
                employeeValidationMessage.className = 'mt-2 text-sm text-green-600';
            } else if (type === 'error') {
                employeeValidationMessage.className = 'mt-2 text-sm text-red-600';
            } else if (type === 'info') {
                employeeValidationMessage.className = 'mt-2 text-sm text-blue-600';
                } else {
                employeeValidationMessage.className = 'mt-2 text-sm';
            }
        }

        // Show validation message for mobile
        function showMobileValidationMessage(message, type) {
            mobileEmployeeValidationMessage.textContent = message;
            if (type === 'success') {
                mobileEmployeeValidationMessage.className = 'mt-2 text-sm text-green-600';
            } else if (type === 'error') {
                mobileEmployeeValidationMessage.className = 'mt-2 text-sm text-red-600';
            } else if (type === 'info') {
                mobileEmployeeValidationMessage.className = 'mt-2 text-sm text-blue-600';
                } else {
                mobileEmployeeValidationMessage.className = 'mt-2 text-sm';
            }
        }
    }

    // Save sale data to database
    async function saveSaleToDatabase() {
        if (!currentEmployee) {
            throw new Error('Employee not validated');
        }

        const subtotal = currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const includeTax = getTaxSetting();
        const tax = includeTax ? subtotal * 0.08 : 0;
        const total = subtotal + tax;
        
        // Get next receipt number from database
        const receiptNumber = await getNextReceiptNumber();
        
        const saleData = {
            receipt_number: receiptNumber.toString().padStart(4, '0'),
            employee_id: currentEmployee.id,
            employee_name: currentEmployee.name,
            employee_code: currentEmployee.employee_code,
            items: currentOrder.map(item => ({
                id: item.id,
                name: item.name,
                quantity: item.quantity,
                price: item.price
            })),
            subtotal: subtotal,
            tax_amount: tax,
            total_amount: total,
            tax_included: includeTax,
            sale_date: new Date().toLocaleString('sv-SE') // YYYY-MM-DD HH:mm:ss format in local timezone
        };

        try {
            const response = await fetch('/api/sales', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(saleData)
            });

            const result = await response.json();
            
            if (result.success) {
                console.log('Sale saved successfully:', result.sale_id);
                return {
                    sale_id: result.sale_id,
                    receipt_number: receiptNumber
                };
            } else {
                throw new Error(result.message || 'Failed to save sale');
            }
        } catch (error) {
            console.error('Error saving sale:', error);
            throw error;
        }
    }

    // Update receipt generation to include tally and employee with ESC/POS commands
    async function generateReceiptContent(receiptNumber, copyType = null) {
        if (!currentEmployee) {
            showNotification('Please validate employee code first', 'error');
            return null;
        }

        if (!receiptNumber) {
            showNotification('Receipt number is required', 'error');
            return null;
        }

        const subtotal = currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const includeTax = getTaxSetting();
        const tax = includeTax ? subtotal * 0.08 : 0;
        const total = subtotal + tax;
        
        const now = new Date();
        const dateStr = now.toLocaleDateString();
        const timeStr = now.toLocaleTimeString();
        
        // ESC/POS commands for thermal printer
        let receipt = '';
        
        // Initialize printer
        receipt += '\x1B\x40'; // ESC @ - Initialize printer
        
        // Fetch hotel name from database
        let displayHotelName = hotelName; // Default fallback
        try {
            const response = await fetch('/api/pos/hotel-settings');
            const data = await response.json();
            if (data.success && data.hotel_name) {
                displayHotelName = data.hotel_name;
            }
        } catch (error) {
            console.error('Error fetching hotel name for receipt:', error);
            // Use default hotelName if fetch fails
        }
        
        // Center alignment and double height for header
        receipt += '\x1B\x61\x01'; // ESC a 1 - Center alignment
        receipt += '\x1B\x21\x30'; // ESC ! 0x30 - Double height and width
        receipt += displayHotelName + '\n';
        receipt += '\x1B\x21\x00'; // ESC ! 0x00 - Normal text
        receipt += 'Restaurant\n';
        receipt += '\x1B\x61\x00'; // ESC a 0 - Left alignment
        
        // Separator line
        receipt += '================================\n';
        
        // Copy type label (if specified)
        if (copyType) {
            receipt += '\x1B\x61\x01'; // Center alignment
            receipt += '\x1B\x21\x10'; // ESC ! 0x10 - Double height
            receipt += `*** ${copyType.toUpperCase()} ***\n`;
            receipt += '\x1B\x21\x00'; // ESC ! 0x00 - Normal text
            receipt += '\x1B\x61\x00'; // Left alignment
            receipt += '--------------------------------\n';
        }
        
        // Order details
        receipt += `Date: ${dateStr}\n`;
        receipt += `Time: ${timeStr}\n`;
        receipt += `Receipt #: ${receiptNumber.toString().padStart(4, '0')}\n`;
        receipt += `Served by: ${currentEmployee.name}\n`;
        receipt += '--------------------------------\n';
        
        // Items
        receipt += 'ITEMS:\n';
        currentOrder.forEach(item => {
            const itemTotal = item.price * item.quantity;
            receipt += `${item.name}\n`;
            receipt += `  ${item.quantity} x KSh ${item.price.toFixed(2)} = KSh ${itemTotal.toFixed(2)}\n`;
        });
        
        receipt += '--------------------------------\n';
        
        // Totals
        receipt += `Subtotal:     KSh ${subtotal.toFixed(2)}\n`;
        if (includeTax) {
            receipt += `Tax (8%):     KSh ${tax.toFixed(2)}\n`;
        }
        receipt += '--------------------------------\n';
        receipt += `TOTAL:        KSh ${total.toFixed(2)}\n`;
        
        // Payment Methods Section
        receipt += '\n';
        receipt += 'PAYMENT METHODS:\n';
        receipt += '--------------------------------\n';
        
        // M-Pesa payment information (only if Show Till setting is enabled)
        if (getTillSetting()) {
            try {
                const response = await fetch('/api/pos/hotel-settings');
                const data = await response.json();
                
                if (data.success) {
                    // Add M-Pesa payment method if configured
                    if (data.payment_method === 'buy_goods' && data.till_number) {
                        receipt += `M-Pesa Buy Goods:\n`;
                        receipt += `Till Number: ${data.till_number}\n`;
                        receipt += '\n';
                    } else if (data.payment_method === 'paybill' && data.business_number) {
                        receipt += `M-Pesa Paybill:\n`;
                        receipt += `Business No: ${data.business_number}\n`;
                        if (data.account_number) {
                            receipt += `Account: ${data.account_number}\n`;
                        }
                        receipt += '\n';
                    }
                }
            } catch (error) {
                console.error('Error fetching payment methods for receipt:', error);
            }
        }
        
        // Always add cash payment
        receipt += 'Cash Payment: Available\n';
        receipt += '\n';
        
        
        // Footer
        receipt += '\x1B\x61\x01'; // Center alignment
        receipt += 'Thank you for your business!\n';
        receipt += 'Visit us again soon!\n';
        receipt += '\x1B\x61\x00'; // Left alignment
        
        // Cut paper
        receipt += '\n\n\n';
        receipt += '\x1D\x56\x00'; // GS V 0 - Full cut
        
        return receipt;
    }

    // Reprint functionality
    function openReprintModal() {
        console.log('Opening reprint modal...');
        const modal = document.getElementById('reprintModal');
        if (modal) {
            modal.classList.remove('hidden');
            loadReprintReceipts();
            updateReprintEmployeeValidationUI();
        } else {
            console.error('Reprint modal not found');
        }
    }

    function closeReprintModal() {
        console.log('Closing reprint modal...');
        const modal = document.getElementById('reprintModal');
        if (modal) {
            modal.classList.add('hidden');
            resetReprintModal();
        }
    }

    function resetReprintModal() {
        selectedReceipt = null;
        reprintEmployee = null;
        
        // Reset to step 1
        showReceiptSelectionStep();
        
        // Reset employee validation
        const employeeCodeInput = document.getElementById('reprintEmployeeCode');
        if (employeeCodeInput) {
            employeeCodeInput.value = '';
        }
        const employeeInfo = document.getElementById('reprintEmployeeInfo');
        if (employeeInfo) {
            employeeInfo.classList.add('hidden');
        }
        const validationMessage = document.getElementById('reprintEmployeeValidationMessage');
        if (validationMessage) {
            validationMessage.textContent = '';
        }
        const validationStatus = document.getElementById('reprintEmployeeValidationStatus');
        if (validationStatus) {
            validationStatus.className = 'w-3 h-3 bg-gray-400 rounded-full';
        }
        
        // Reset receipts list
        const receiptsList = document.getElementById('receiptsList');
        const receiptsLoading = document.getElementById('receiptsLoading');
        const receiptsEmpty = document.getElementById('receiptsEmpty');
        
        if (receiptsList) {
            receiptsList.innerHTML = '';
            receiptsList.classList.add('hidden');
        }
        if (receiptsLoading) {
            receiptsLoading.classList.remove('hidden');
        }
        if (receiptsEmpty) {
            receiptsEmpty.classList.add('hidden');
        }
    }

    async function loadReprintReceipts() {
        console.log('Loading reprint receipts...');
        try {
            const response = await fetch('/api/receipts');
            if (response.ok) {
                const data = await response.json();
                reprintReceipts = data.receipts || [];
                renderReprintReceipts();
            } else {
                console.error('Failed to load receipts:', response.statusText);
                showNotification('Failed to load receipts', 'error');
            }
        } catch (error) {
            console.error('Error loading receipts:', error);
            showNotification('Error loading receipts', 'error');
        }
    }

    function renderReprintReceipts() {
        const receiptsList = document.getElementById('receiptsList');
        const receiptsLoading = document.getElementById('receiptsLoading');
        const receiptsEmpty = document.getElementById('receiptsEmpty');

        receiptsLoading.classList.add('hidden');

        if (reprintReceipts.length === 0) {
            receiptsEmpty.classList.remove('hidden');
            return;
        }

        receiptsEmpty.classList.add('hidden');
        receiptsList.classList.remove('hidden');

        receiptsList.innerHTML = reprintReceipts.map(receipt => `
            <div class="receipt-item bg-white border border-gray-200 rounded-lg p-4 hover:border-purple-300 hover:shadow-md transition-all duration-200 cursor-pointer" data-receipt-id="${receipt.id}">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <div class="flex items-center space-x-3 mb-2">
                            <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-receipt text-purple-600 text-sm"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">Receipt #${receipt.receipt_number}</h4>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm text-gray-600">
                            <div>
                                <span class="font-medium">Items:</span> ${receipt.item_count || 0}
                            </div>
                            <div>
                                <span class="font-medium">Total:</span> KSh ${parseFloat(receipt.total_amount).toFixed(2)}
                            </div>
                        </div>
                    </div>
                    <div class="ml-4">
                        <div class="w-4 h-4 border-2 border-gray-300 rounded-full receipt-radio"></div>
                    </div>
                </div>
            </div>
        `).join('');

        // Add click event listeners to receipt items
        receiptsList.querySelectorAll('.receipt-item').forEach(item => {
            item.addEventListener('click', function() {
                // Remove selection from all items
                receiptsList.querySelectorAll('.receipt-item').forEach(i => {
                    i.classList.remove('border-purple-500', 'bg-purple-50');
                    i.querySelector('.receipt-radio').className = 'w-4 h-4 border-2 border-gray-300 rounded-full receipt-radio';
                });
                
                // Select current item
                this.classList.add('border-purple-500', 'bg-purple-50');
                this.querySelector('.receipt-radio').className = 'w-4 h-4 border-2 border-purple-500 rounded-full receipt-radio bg-purple-500';
                
                // Store selected receipt
                const receiptId = this.dataset.receiptId;
                selectedReceipt = reprintReceipts.find(r => r.id == receiptId);
                console.log('Selected receipt:', selectedReceipt);
                
                // Show selected receipt details and move to step 2
                showSelectedReceiptDetails();
                showEmployeeValidationStep();
            });
        });
    }

    function showSelectedReceiptDetails() {
        if (!selectedReceipt) return;
        
        const detailsDiv = document.getElementById('selectedReceiptDetails');
        if (detailsDiv) {
            const saleDate = new Date(selectedReceipt.sale_date);
            detailsDiv.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <span class="font-medium text-gray-600">Receipt #:</span> ${selectedReceipt.receipt_number}
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Items:</span> ${selectedReceipt.item_count || 0}
                    </div>
                    <div>
                        <span class="font-medium text-gray-600">Total:</span> KSh ${parseFloat(selectedReceipt.total_amount).toFixed(2)}
                    </div>
                </div>
            `;
        }
    }

    function showEmployeeValidationStep() {
        // Hide receipt selection step
        const receiptStep = document.getElementById('receiptSelectionStep');
        const employeeStep = document.getElementById('employeeValidationStep');
        
        if (receiptStep) receiptStep.classList.add('hidden');
        if (employeeStep) employeeStep.classList.remove('hidden');
        
        // Focus on employee code input
        const employeeCodeInput = document.getElementById('reprintEmployeeCode');
        if (employeeCodeInput) {
            setTimeout(() => employeeCodeInput.focus(), 100);
        }
    }

    function showReceiptSelectionStep() {
        // Hide employee validation step
        const receiptStep = document.getElementById('receiptSelectionStep');
        const employeeStep = document.getElementById('employeeValidationStep');
        
        if (receiptStep) receiptStep.classList.remove('hidden');
        if (employeeStep) employeeStep.classList.add('hidden');
        
        // Reset employee validation
        reprintEmployee = null;
        const employeeCodeInput = document.getElementById('reprintEmployeeCode');
        if (employeeCodeInput) {
            employeeCodeInput.value = '';
        }
        const employeeInfo = document.getElementById('reprintEmployeeInfo');
        if (employeeInfo) {
            employeeInfo.classList.add('hidden');
        }
        const validationMessage = document.getElementById('reprintEmployeeValidationMessage');
        if (validationMessage) {
            validationMessage.textContent = '';
        }
        const validationStatus = document.getElementById('reprintEmployeeValidationStatus');
        if (validationStatus) {
            validationStatus.className = 'w-3 h-3 bg-gray-400 rounded-full';
        }
    }

    function updateReprintEmployeeValidationUI() {
        const isConnected = isPrinterConnected();
        const employeeCodeInput = document.getElementById('reprintEmployeeCode');
        const warningDiv = document.getElementById('reprintEmployeeValidationWarning');
        const statusDiv = document.getElementById('reprintEmployeeValidationStatus');

        if (!employeeCodeInput || !warningDiv || !statusDiv) {
            console.error('Reprint employee validation elements not found');
            return;
        }

        if (isConnected) {
            employeeCodeInput.disabled = false;
            employeeCodeInput.placeholder = '0000';
            employeeCodeInput.classList.remove('bg-gray-100', 'text-gray-400');
            employeeCodeInput.classList.add('bg-white', 'text-gray-900');
            warningDiv.classList.add('hidden');
            statusDiv.className = 'w-3 h-3 bg-green-400 rounded-full animate-pulse';
        } else {
            employeeCodeInput.disabled = true;
            employeeCodeInput.placeholder = 'Connect printer first';
            employeeCodeInput.classList.add('bg-gray-100', 'text-gray-400');
            employeeCodeInput.classList.remove('bg-white', 'text-gray-900');
            warningDiv.classList.remove('hidden');
            statusDiv.className = 'w-3 h-3 bg-red-400 rounded-full animate-pulse';
        }
    }

    async function validateReprintEmployee() {
        const employeeCode = document.getElementById('reprintEmployeeCode').value;
        const messageDiv = document.getElementById('reprintEmployeeValidationMessage');
        const infoDiv = document.getElementById('reprintEmployeeInfo');
        const statusDiv = document.getElementById('reprintEmployeeValidationStatus');

        if (employeeCode.length !== 4) {
            messageDiv.textContent = '';
            infoDiv.classList.add('hidden');
            statusDiv.className = 'w-3 h-3 bg-gray-400 rounded-full';
            reprintEmployee = null;
            return;
        }

        try {
            const response = await fetch('/employee/validate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ employee_code: employeeCode })
            });

            const data = await response.json();

            if (data.success && data.employee) {
                reprintEmployee = data.employee;
                messageDiv.textContent = '✓ Employee validated! Reprinting receipt...';
                messageDiv.className = 'mt-2 text-sm text-green-600';
                infoDiv.classList.remove('hidden');
                document.getElementById('reprintEmployeeName').textContent = data.employee.name;
                document.getElementById('reprintEmployeeCodeDisplay').textContent = `Code: ${data.employee.employee_code}`;
                statusDiv.className = 'w-3 h-3 bg-green-400 rounded-full animate-pulse';
                
                // Auto-reprint the receipt
                setTimeout(() => {
                    reprintSelectedReceipt();
                }, 1000);
            } else {
                reprintEmployee = null;
                messageDiv.textContent = '✗ Invalid employee code';
                messageDiv.className = 'mt-2 text-sm text-red-600';
                infoDiv.classList.add('hidden');
                statusDiv.className = 'w-3 h-3 bg-red-400 rounded-full animate-pulse';
            }
        } catch (error) {
            console.error('Error validating employee:', error);
            reprintEmployee = null;
            messageDiv.textContent = '✗ Error validating employee';
            messageDiv.className = 'mt-2 text-sm text-red-600';
            infoDiv.classList.add('hidden');
            statusDiv.className = 'w-3 h-3 bg-red-400 rounded-full animate-pulse';
        }
    }

    async function reprintSelectedReceipt() {
        if (!selectedReceipt || !reprintEmployee) {
            showNotification('Please select a receipt and validate employee', 'error');
            return;
        }

        try {
            // Get the receipt details
            const response = await fetch(`/api/receipts/${selectedReceipt.id}`);
            if (!response.ok) {
                throw new Error('Failed to fetch receipt details');
            }

            const receiptData = await response.json();
            
            // Generate receipt content for reprinting
            const receiptContent = generateReprintReceiptContent(receiptData);
            
            // Print the receipt
            const connectedPrinters = window.bluetoothPrinterManager.getConnectedPrinters();
            if (connectedPrinters.length > 0) {
                const results = await window.bluetoothPrinterManager.printToAllPrinters(receiptContent);
                const successCount = results.filter(r => r.success).length;
                
                if (successCount > 0) {
                    // Log the reprint action to the database
                    try {
                        await fetch(`/api/receipts/${selectedReceipt.id}/reprint`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                employee_code: reprintEmployee.employee_code
                            })
                        });
                    } catch (logError) {
                        console.warn('Failed to log reprint action:', logError);
                    }
                    
                    showNotification(`Receipt #${selectedReceipt.receipt_number} reprinted successfully by ${reprintEmployee.name}`, 'success');
                    closeReprintModal();
                } else {
                    showNotification('Failed to print receipt. Please check printer connections.', 'error');
                }
            } else {
                showNotification('No printer connected', 'error');
            }
        } catch (error) {
            console.error('Error reprinting receipt:', error);
            showNotification('Error reprinting receipt', 'error');
        }
    }

    function generateReprintReceiptContent(receiptData) {
        const receipt = receiptData.receipt;
        const items = receiptData.items;
        
        // ESC/POS commands for thermal printer
        let receiptContent = '';
        
        // Initialize printer
        receiptContent += '\x1B\x40'; // ESC @ - Initialize printer
        
        // Center alignment and double height for header
        receiptContent += '\x1B\x61\x01'; // ESC a 1 - Center alignment
        receiptContent += '\x1B\x21\x30'; // ESC ! 0x30 - Double height and width
        receiptContent += hotelName + '\n';
        receiptContent += '\x1B\x21\x00'; // ESC ! 0x00 - Normal text
        receiptContent += 'Restaurant\n';
        receiptContent += '\x1B\x61\x00'; // ESC a 0 - Left alignment
        
        // Separator line
        receiptContent += '================================\n';
        
        // Reprint notice
        receiptContent += '\x1B\x21\x10'; // ESC ! 0x10 - Double height
        receiptContent += '*** REPRINT ***\n';
        receiptContent += '\x1B\x21\x00'; // ESC ! 0x00 - Normal text
        
        // Order details
        const saleDate = new Date(receipt.sale_date);
        receiptContent += `Date: ${saleDate.toLocaleDateString()}\n`;
        receiptContent += `Time: ${saleDate.toLocaleTimeString()}\n`;
        receiptContent += `Receipt #: ${receipt.receipt_number}\n`;
        receiptContent += `Original: ${receipt.employee_name}\n`;
        receiptContent += `Reprinted by: ${reprintEmployee.name}\n`;
        receiptContent += '--------------------------------\n';
        
        // Items
        receiptContent += 'ITEMS:\n';
        items.forEach(item => {
            const unitPrice = parseFloat(item.unit_price) || 0;
            const quantity = parseInt(item.quantity) || 0;
            const itemTotal = unitPrice * quantity;
            receiptContent += `${item.item_name}\n`;
            receiptContent += `  ${quantity} x KSh ${unitPrice.toFixed(2)} = KSh ${itemTotal.toFixed(2)}\n`;
        });
        
        receiptContent += '--------------------------------\n';
        
        // Totals
        const subtotal = parseFloat(receipt.subtotal) || 0;
        const taxAmount = parseFloat(receipt.tax_amount) || 0;
        const totalAmount = parseFloat(receipt.total_amount) || 0;
        
        receiptContent += `Subtotal:     KSh ${subtotal.toFixed(2)}\n`;
        if (taxAmount > 0) {
            receiptContent += `Tax (8%):     KSh ${taxAmount.toFixed(2)}\n`;
        }
        receiptContent += '--------------------------------\n';
        receiptContent += `TOTAL:        KSh ${totalAmount.toFixed(2)}\n`;
        
        // Footer
        receiptContent += '\n';
        receiptContent += '\x1B\x61\x01'; // Center alignment
        receiptContent += 'Thank you for your business!\n';
        receiptContent += 'Visit us again soon!\n';
        receiptContent += '\x1B\x61\x00'; // Left alignment
        
        // Cut paper
        receiptContent += '\n\n\n';
        receiptContent += '\x1D\x56\x00'; // GS V 0 - Full cut
        
        return receiptContent;
    }

    // Initialize everything when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        initializeEmployeeValidation();
        updateEmployeeValidationUI();
        
        // Reprint modal event listeners
        const reprintBtn = document.getElementById('reprintBtn');
        const closeReprintModalBtn = document.getElementById('closeReprintModal');
        const cancelReprintBtn = document.getElementById('cancelReprint');
        const refreshReceiptsBtn = document.getElementById('refreshReceipts');
        const reprintEmployeeCodeInput = document.getElementById('reprintEmployeeCode');
        const changeReceiptBtn = document.getElementById('changeReceiptBtn');

        if (reprintBtn) {
            reprintBtn.addEventListener('click', openReprintModal);
        }

        if (closeReprintModalBtn) {
            closeReprintModalBtn.addEventListener('click', closeReprintModal);
        }

        if (cancelReprintBtn) {
            cancelReprintBtn.addEventListener('click', closeReprintModal);
        }

        if (refreshReceiptsBtn) {
            refreshReceiptsBtn.addEventListener('click', loadReprintReceipts);
        }

        if (reprintEmployeeCodeInput) {
            reprintEmployeeCodeInput.addEventListener('input', function() {
                if (this.value.length === 4) {
                    validateReprintEmployee();
                } else {
                    reprintEmployee = null;
                }
            });
        }

        if (changeReceiptBtn) {
            changeReceiptBtn.addEventListener('click', showReceiptSelectionStep);
        }

        // Update reprint employee validation UI when printer status changes
        document.addEventListener('bluetoothPrinterStatus', function() {
            updateReprintEmployeeValidationUI();
        });

        // Periodic update for reprint employee validation UI
        setInterval(() => {
            updateReprintEmployeeValidationUI();
        }, 2000);
    });
    
    // Manual printer setup for hosted environments
    window.setupManualPrinter = async function(ip, port = 9100, name = null) {
        console.log('🔧 Setting up manual printer...');
        try {
            if (!window.separateWiFiManager) {
                console.error('❌ WiFi Manager not available');
                return false;
            }
            
            const result = await window.separateWiFiManager.setupManualPrinter(ip, port, name);
            console.log('✅ Manual printer setup result:', result);
            return result;
        } catch (error) {
            console.error('❌ Manual printer setup failed:', error);
            return false;
        }
    };
    
    // Show manual printer setup modal
    window.showManualPrinterSetup = function() {
        const modal = document.createElement('div');
        modal.id = 'manual-printer-modal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Manual Printer Setup</h3>
                <p class="text-gray-600 mb-4">Enter your thermal printer's IP address and port to connect manually.</p>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Printer Name</label>
                        <input type="text" id="manualPrinterName" placeholder="My Thermal Printer" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-orange">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">IP Address</label>
                        <input type="text" id="manualPrinterIP" placeholder="192.168.1.100" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-orange">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Port</label>
                        <input type="number" id="manualPrinterPort" value="9100" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-orange">
                    </div>
                </div>
                
                <div class="flex space-x-3 mt-6">
                    <button onclick="testManualPrinter()" 
                            class="flex-1 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        Test Connection
                    </button>
                    <button onclick="connectManualPrinter()" 
                            class="flex-1 bg-primary-orange text-white px-4 py-2 rounded-lg hover:bg-secondary-orange transition-colors">
                        Connect
                    </button>
                    <button onclick="closeManualPrinterModal()" 
                            class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    };
    
    // Test manual printer connection
    window.testManualPrinter = async function() {
        const ip = document.getElementById('manualPrinterIP').value;
        const port = parseInt(document.getElementById('manualPrinterPort').value) || 9100;
        
        if (!ip) {
            alert('Please enter an IP address');
            return;
        }
        
        try {
            const result = await setupManualPrinter(ip, port, 'Test Printer');
            if (result) {
                alert('✅ Connection test successful!');
            } else {
                alert('❌ Connection test failed');
            }
        } catch (error) {
            alert('❌ Connection test failed: ' + error.message);
        }
    };
    
    // Connect manual printer
    window.connectManualPrinter = async function() {
        const name = document.getElementById('manualPrinterName').value;
        const ip = document.getElementById('manualPrinterIP').value;
        const port = parseInt(document.getElementById('manualPrinterPort').value) || 9100;
        
        if (!ip) {
            alert('Please enter an IP address');
            return;
        }
        
        try {
            const result = await setupManualPrinter(ip, port, name);
            if (result) {
                alert('✅ Printer connected successfully!');
                closeManualPrinterModal();
                updateEmployeeValidationUI();
            } else {
                alert('❌ Failed to connect printer');
            }
        } catch (error) {
            alert('❌ Connection failed: ' + error.message);
        }
    };
    
    // Close manual printer modal
    window.closeManualPrinterModal = function() {
        const modal = document.getElementById('manual-printer-modal');
        if (modal) {
            modal.remove();
        }
    };
</script>
{% endblock %}
